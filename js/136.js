(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[136],{67394:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>CursorController});var a=i(47724),s=i(68113),n=i(94329),r=i(35597),o=i(69941),d=i(19047),l=i(75892),u=i(56241),m=i(33874),h=i(55461),c=i(69927),g=i(63781);class CursorController extends a.Y{constructor(){super(...arguments),this.name="cursor-controller",this.visibilityRules=[],this.disabled=!1}async init(t,e){[this.cursorMesh,this.cursorData]=await Promise.all([e.getModule(s.default),e.market.waitForData(c.Y)]),this.visibilityRules.push((()=>{const t=e.market.tryGetData(r.O);return!!t&&(0,n.Bw)(t.closestMode)}),(()=>{const t=e.market.tryGetData(l.Z);return!!t&&!t.isSweepUnaligned(t.currentSweep)}),(()=>{const t=e.market.tryGetData(o.k3);return!!t&&!t.isTourActive()}),(()=>{const t=e.market.tryGetData(d.Z);return!!t&&!t.isMobile()}),(()=>{const t=e.market.tryGetData(m.e);return!!t&&t.tryGetProperty(h.b,!0)})),this.bindings.push(e.commandBinder.addBinding(u.y,(async t=>{this.disabled=t.disable})))}onUpdate(){this.updateCursorVisibility()}addVisibilityRule(t){this.visibilityRules.push(t)}removeVisibilityRule(t){const e=this.visibilityRules.indexOf(t);-1!==e&&this.visibilityRules.splice(e,1)}setFadeProps(t){const{fadeOut:e,fadeIn:i}=t;g.default.fadeOutDuration=e&&e.duration?e.duration:g.default.fadeOutDuration,g.default.fadeOutDelay=e&&e.delay?e.delay:g.default.fadeOutDelay,g.default.fadeInDuration=i&&i.duration?i.duration:g.default.fadeInDuration}updateCursorVisibility(){const t=!this.disabled&&this.visibilityRules.reduce(((t,e)=>t&&e()),!0);this.cursorMesh.setVisible(t)}setTexture(t){this.cursorData.texture=t}}},76265:(t,e,i)=>{"use strict";i.r(e),i.d(e,{ModelRatedMessage:()=>n.E,SubmitModelRatingCommand:()=>r.M,ToggleModelRatingDialogCommand:()=>r.m,default:()=>f});var a=i(47724),s=i(98811),n=i(62627),r=i(43229),o=i(89046),d=i(49080),l=i(38330);const u=new(i(88512).Z)("model-rating-data-store"),m=t=>t,h=t=>t;class ModelRatingDataStore extends l.MU{constructor(t,e,i){super({queue:t,deserialize:m,serialize:h,path:`${e}/api/v1/jsonstore/model/model-rating/${i}`})}async canPromptRating(){let t;try{t=await this.read()}catch(t){return u.error("Failed to read existing rating data from JSONStore"),!1}const e=!!t.rated_at;return!!!t.prompt_dismissed_at&&!e}async recordRatingSubmitted(){this.update({rated_at:(new Date).toISOString()})}async recordAutomaticPromptDismissed(){this.update({prompt_dismissed_at:(new Date).toISOString()})}}var c=i(38587),g=i(55305),p=i(33874),b=i(8445);const D=t=>864e5*t,w=D(1),y=D(7);class ModelRatingModule extends a.Y{constructor(){super(...arguments),this.name="model-rating",this.promptEnabled=!1,this.totalActiveTime=0,this.wasLastOpeningAutomatic=!1,this.canPrompt=async()=>{const t=Date.now(),e=this.settings.tryGetProperty(g.F.LastRatingPromptTime,null),i=!e||+new Date(t)-+new Date(e)>=w,a=await this.store.canPromptRating();return i&&a},this.handleActivityPingMessage=async t=>{if(this.totalActiveTime+=t.durationDollhouse+t.durationFloorplan+t.durationInside,this.totalActiveTime<44500||!this.promptEnabled)return;this.engine.unsubscribe(c.i,this.handleActivityPingMessage);if(await this.canPrompt()&&!this.viewData.getIsDialogVisible()){const t=(new Date).toISOString();this.settings.setLocalStorageProperty(g.F.LastRatingPromptTime,t),this.engine.commandBinder.issueCommand(new r.m(!0)),this.wasLastOpeningAutomatic=!0}},this.handleSubmitModelRatingCommand=async({rating:t,didFinish:e})=>{this.log.info(t),this.engine.broadcast(new n.E(t)),this.store.recordRatingSubmitted(),e&&(this.engine.commandBinder.issueCommand(new r.m(!1)),this.engine.commandBinder.issueCommand(new o.Bz(d.P.RATING_THANK_YOU,!0)))},this.handleToggleDialogCommand=async({toVisible:t})=>{this.viewData.setDialogVisible(t);!this.viewData.getIsDialogVisible()&&this.wasLastOpeningAutomatic&&(this.store.recordAutomaticPromptDismissed(),this.wasLastOpeningAutomatic=!1)}}async init(t,e){this.engine=e,this.viewData=new s.P,this.store=new ModelRatingDataStore(t.queue,t.baseUrl,t.modelId),this.promptEnabled=t.promptEnabled,this.settings=await e.market.waitForData(p.e),this.modelData=await e.market.waitForData(b.T),this.bindings.push(e.commandBinder.addBinding(r.m,this.handleToggleDialogCommand),e.commandBinder.addBinding(r.M,this.handleSubmitModelRatingCommand));const i=this.modelData.model.created,a=!!i&&Date.now()-+new Date(i)<y;this.promptEnabled&&a&&this.bindings.push(e.subscribe(c.i,this.handleActivityPingMessage)),e.market.register(this,s.P,this.viewData)}dispose(t){this.bindings.forEach((t=>{t.cancel()})),this.bindings=[],super.dispose(t)}}const f=ModelRatingModule}}]);