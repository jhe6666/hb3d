(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[464],{22569:(t,e,a)=>{"use strict";a.r(e),a.d(e,{SearchModeToggleCommand:()=>o.X,SendQueryCommand:()=>o.H,default:()=>P});var i,s=a(47724),n=a(40698),r=a(74371),h=a(38003),o=a(62644),d=a(4141);!function(t){t[t.Instant=0]="Instant",t[t.FadeToBlack=1]="FadeToBlack",t[t.Interpolate=2]="Interpolate",t[t.MoveToBlack=3]="MoveToBlack"}(i||(i={}));var c=a(90662),l=a(6460),m=a(29422),g=a(60225);function u(t){return`rgb(${255*t.r}, ${255*t.g}, ${255*t.b})`}const p=t=>{if(((t="")=>t.trim().startsWith("{"))(t.description))try{const e=JSON.parse(t.description);return e.title=t.label,e}catch(t){}return null};class MattertagSearchResultItem{constructor(t,e){this.mattertag=t,this.engine=e,this.id=this.mattertag.sid,this.title=this.mattertag.label,this.description=this.mattertag.description,this.type=d.B.MATTERTAG,this.floorId=this.mattertag.floorId,this.color=u(this.mattertag.color),this.metadata=p(this.mattertag),this.onSelect=()=>{this.engine.commandBinder.issueCommand(new c.ew),this.engine.commandBinder.issueCommand(new g.Y(this.mattertag.sid,i.Interpolate))}}}class TagSearchResultItem{constructor(t,e){this.mattertag=t,this.engine=e,this.id=this.mattertag.sid,this.title=this.mattertag.label,this.description=this.mattertag.description,this.type=d.B.MATTERTAG,this.floorId=this.mattertag.floorId,this.color=u(this.mattertag.color),this.metadata=p(this.mattertag),this.onSelect=async()=>{const{anchorPosition:t,stemVector:e,stemHeight:a}=this.mattertag,s={anchorPosition:t,stemNormal:e,stemLength:a};this.engine.commandBinder.issueCommand(new c.ew),await this.engine.commandBinder.issueCommand(new m.OR({pinPosition:s,transition:i.Interpolate})),this.engine.commandBinder.issueCommand(new c.oM(this.id,l.J.TAG))}}}class LabelSearchResultItem{constructor(t,e){this.label=t,this.engine=e,this.id=this.label.sid,this.title=this.label.text,this.type=d.B.LABEL,this.floorId=this.label.floorId,this.onSelect=()=>{this.engine.commandBinder.issueCommand(new c.ew),this.engine.commandBinder.issueCommand(new m.Cs(this.label))}}}var w=a(79553),D=a(24151),y=a(92532),S=a(23953),b=a(27326);class SearchManager{constructor(t,e){this.engine=t,this.initialized=!1}async activate(){if(!this.initialized){const t=this.engine.market;await Promise.all([t.waitForData(b.c)]).then((([t])=>{this.floorsViewData=t})),this.initialized=!0}await this.engine.commandBinder.issueCommand(new o.X(!0))}async deactivate(){await this.engine.commandBinder.issueCommand(new o.X(!1))}}var T=a(33874),R=a(13789),C=a(8150),B=a(48544),M=a(69617),f=a(86010),v=a(21479),I=a(89046),A=a(86580),k=a(98292);const{TOOLS:L}=R.Z;class SearchModule extends s.Y{constructor(){super(...arguments),this.name="search",this.itemList=[],this.searchResultsData=new M.r,this.activated=!1,this.textParser=new f.v({links:!0}),this.getPlainText=t=>this.textParser.getPlainText(t),this.dataDirty=!0,this.onApplicationChange=async()=>{this.toolsData.getTool(w.w1.SEARCH)||this.registerTool()},this.setDataToDirty=()=>{this.dataDirty=!0,this.debouncedUpdateSearch()},this.updateItemList=async()=>{const{dataMap:t,engine:e}=this,a=[];t.mattertagsData.iterate((t=>{t.enabled&&(this.config.newTagsEnabled?a.push(new TagSearchResultItem(t,e)):a.push(new MattertagSearchResultItem(t,e)))})),t.labelData.iterate((t=>{t.visible&&a.push(new LabelSearchResultItem(t,e))})),this.itemList=a,this.dataDirty=!1},this.toggleSearchMode=async t=>{t.opened?this.activateTool():this.deactivateTool()},this.searchItemsSimple=(t,e)=>{e=e.toLowerCase();const a=t.title,i=t.description;return a.toLowerCase().includes(e)||!!i&&this.getPlainText(i).toLowerCase().includes(e)},this.handleSendQueryCommand=async t=>{this.searchResultsData.setQuery(t.query),this.debouncedUpdateSearch()},this.updateSearch=async()=>{this.dataDirty&&await this.updateItemList();const t=this.searchResultsData.getQuery()||"",e=this.searchResultsData.getIsAdvancedQuery();let a=[],i=null,s=this.searchItemsSimple;if(e){let e=t=>!1;try{e=(0,A.U)(t)}catch(t){i=t}s=t=>!(!t.metadata||!e(t.metadata))}a=this.itemList.filter((e=>{const a=s(e,t);return e.type===d.B.MATTERTAG&&this.pinRenderer.setPinVisible(e.id,a),a})),this.searchResultsData.setValidationError(i),this.searchResultsData.setResults(a)},this.debouncedUpdateSearch=(0,k.D)(this.updateSearch,200)}async init(t,e){let a;this.config=t,this.engine=e,this.registerTool(),await this.updateDataMap(),[this.settingsData,this.toolsData,a,this.appData]=await Promise.all([e.market.waitForData(T.e),e.market.waitForData(D.t),e.getModule(B.default),e.market.waitForData(v.pu)]),this.pinRenderer=a.pinRenderer,this.bindings.push(e.commandBinder.addBinding(o.X,this.toggleSearchMode),e.commandBinder.addBinding(o.H,this.handleSendQueryCommand),e.subscribe(C.bS,this.onApplicationChange)),e.market.register(this,M.r,this.searchResultsData),t.urlQuery&&this.engine.commandBinder.issueCommand(new y.tT(w.w1.SEARCH,!0))}registerTool(){const t=new S.U({id:w.w1.SEARCH,namePhraseKey:L.SEARCH,panel:!0,panelLeft:!0,icon:"icon-magnifying-glass",analytic:"search_mode",toolbar:!1,dimmed:!1,enabled:!0,hidesAppBar:!0,manager:new SearchManager(this.engine)});this.engine.commandBinder.issueCommand(new y.MV([t]))}async updateDataMap(){const{engine:t}=this,[e,a,i]=await Promise.all([t.market.waitForData(n.n),t.market.waitForData(r.D),t.market.waitForData(h.X)]);this.dataMap={mattertagsData:e,labelData:a,measurementModeData:i}}activateTool(){const{config:t}=this;if(this.activated)return;t.workshop&&this.appData.application===v.Mx.WORKSHOP&&this.engine.commandBinder.issueCommand(new I.Mn(!1)),this.toolActiveBindings=[this.settingsData.onChanged(this.setDataToDirty),...Object.values(this.dataMap).map((t=>t.onChanged(this.setDataToDirty)))];const e=decodeURIComponent(t.urlQuery||"");this.activated=!0,this.searchResultsData.setIsAdvancedSearchEnabled(t.advancedSearchEnabled),this.searchResultsData.setQuery(e),this.updateSearch()}deactivateTool(){this.activated&&(this.config.workshop&&this.appData.application===v.Mx.WORKSHOP&&this.engine.commandBinder.issueCommand(new I.Mn(!0)),this.toolActiveBindings.forEach((t=>{t.cancel()})),this.toolActiveBindings=[],this.activated=!1,this.searchResultsData.setQuery(null),this.resetAllVisibility())}resetAllVisibility(){this.itemList.filter((t=>t.type===d.B.MATTERTAG)).forEach((t=>this.pinRenderer.setPinVisible(t.id,!0)))}}const P=SearchModule}}]);