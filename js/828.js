(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[828],{77598:(e,t,s)=>{"use strict";s.d(t,{g:()=>S});var i=s(85893),r=s(94184),n=s.n(r),a=s(6989),o=s(12019),l=s(56943),d=s(67294),h=s(10067),c=s(64016),u=s(92608),m=s(71964),g=s(59417),p=s(13789);const{BLURS:v}=p.Z.WORKSHOP,f=({group:e})=>{const{id:t,title:s,items:r}=e;return(0,i.jsx)(o._m,{id:t,title:`${s} (${r.length})`},void 0)},b=({item:e})=>{const t=(0,g.b)();if(!e){const e=t.t(v.MULTI_FLOOR_EMPTY_MESSAGE);return(0,i.jsx)(o.gQ,{message:e},void 0)}return(0,i.jsx)(c.K,{blur:e},void 0)},S=({className:e="",manager:t})=>{const{blurList:s}=t.dataMap,r=(0,g.b)(),[c,p]=(0,d.useState)(null),{groups:S,groupBy:C,setGroupBy:T}=(0,u.l)(s,t),w=(0,d.useCallback)((e=>{(0,l.p)(a.Q,e)?s.setFilter("status",(t=>t.status===e)):s.clearFilter("status"),p(e)}),[s]),[B,E]=(0,d.useState)(null),y=(0,d.useCallback)((e=>{switch(e){case"CREATED_DESC":s.sort(((e,t)=>e.created.getTime()-t.created.getTime()||e.index-t.index));break;case"CREATED_ASC":s.sort(((e,t)=>t.created.getTime()-e.created.getTime()||t.index-e.index))}E(e)}),[s]),M=n()(e,"blur-list"),I=r.t(v.NO_BLURS);return(0,i.jsxs)("div",Object.assign({className:M},{children:[(0,i.jsxs)("header",Object.assign({className:"blur-list-header"},{children:[(0,i.jsx)(m.n,{},void 0),(0,i.jsxs)(o.w0,{children:[(0,i.jsx)(h.nx,{value:C,onChange:T},void 0),(0,i.jsx)(h.rr,{value:c,onChange:w},void 0),(0,i.jsx)(h.zj,{value:B,onChange:y},void 0)]},void 0)]}),void 0),(0,i.jsx)("div",Object.assign({className:"blur-list-content"},{children:0===S.length?(0,i.jsx)(o.gQ,{message:I,itemHeight:42},void 0):(0,i.jsx)(o.UQ,{data:S,itemHeight:42,renderItem:b,renderGroup:f},void 0)}),void 0)]}),void 0)}},64016:(e,t,s)=>{"use strict";s.d(t,{K:()=>w});var i=s(85893),r=s(94184),n=s.n(r),a=s(67467),o=s(6989),l=s(25813),d=s(96005),h=s(59417),c=s(13789),u=s(79553),m=s(92532),g=s(12019),p=s(67294),v=s(81960),f=s(14576),b=s(60343),S=s(97523),C=s(977);const{BLURS:T}=c.Z.WORKSHOP;function w({blur:e}){const{commandBinder:t,toolsData:s}=(0,p.useContext)(l.I),r=(0,b.t)(),c=(0,S.p)(),w=(0,C.z)(),B=(0,h.b)(),E=(0,p.useCallback)((()=>{t.issueCommand(new v.mP(e)),t.issueCommand(new v.AQ(f.t.IDLE)),s.toolPanelLayout===u.wS.BOTTOM_PANEL&&t.issueCommand(new m.zK(!0))}),[t,s,e]),y=(0,p.useCallback)((s=>{e.visible?t.issueCommand(new v.R8(e.id)):t.issueCommand(new v.MU(e.id)),s.stopPropagation()}),[t,e]),M=(0,p.useCallback)((()=>{t.issueCommand(new a.TL(e.id))}),[t,e]),I=(0,p.useCallback)((()=>{r&&(r.hoveredBlur=e)}),[e,r]),j=(0,p.useCallback)((()=>{r&&(r.hoveredBlur=null)}),[r]),x=(0,i.jsxs)("span",{children:[B.t(T.DEFAULT_BLUR_NAME,{number:e.index}),e.status!==o.Q.PENDING&&(0,i.jsx)("span",Object.assign({className:"blur-status"},{children:e.status}),void 0)]},void 0),D=(0,i.jsxs)(g.hE,{children:[(0,i.jsx)(g.zx,{icon:e.visible?"eye-show":"eye-hide",onClick:y},void 0),(0,i.jsx)(d.e,{id:e.id,disabled:!e.editable,menu:[[T.DELETE_BLUR_CTA,M]],closeOnMenuItemClick:!0},void 0)]},void 0),R=n()("blur-list-item",{active:c&&c.id===e.id},{hover:w&&w.id===e.id});return(0,i.jsx)(g.HC,{className:R,onClick:E,onMouseEnter:I,onMouseLeave:j,actions:D,title:x},void 0)}},10067:(e,t,s)=>{"use strict";s.d(t,{rr:()=>h,nx:()=>c,zj:()=>u});var i=s(85893);if(984==s.j)var r=s(6989);if(984==s.j)var n=s(8378);if(984==s.j)var a=s(59417);var o=s(13789);if(984==s.j)var l=s(43513);const{BLURS:d}=o.Z.WORKSHOP,h=({value:e,onChange:t})=>{const s=(0,a.b)(),o=[{text:s.t(d.BLUR_STATUS_ALL),value:"all",selected:"all"===e},{text:s.t(d.BLUR_STATUS_PENDING),value:r.Q.PENDING,selected:e===r.Q.PENDING},{text:s.t(d.BLUR_STATUS_APPLIED),value:r.Q.APPLIED,selected:e===r.Q.APPLIED},{text:s.t(d.BLUR_STATUS_FAILED),value:r.Q.FAILED,selected:e===r.Q.FAILED}];return(0,i.jsx)(n.S,{className:"blur-filter blur-filter-status",menuStyle:n.K.DROPDOWN,onChange:t,options:o,placeholder:s.t(d.STATUS)},void 0)},c=({value:e,onChange:t})=>{const s=(0,a.b)(),r=[{text:s.t(d.GROUP_BY_SCAN),value:l.g.SCANS,selected:e===l.g.SCANS},{text:s.t(d.GROUP_BY_FLOOR),value:l.g.FLOORS,selected:e===l.g.FLOORS}];return(0,i.jsx)(n.S,{className:"blur-filter blur-filter-groupby",menuStyle:n.K.DROPDOWN,onChange:t,options:r,placeholder:s.t(d.GROUP_BY)},void 0)},u=({value:e,onChange:t})=>{const s=(0,a.b)(),r=[{text:s.t(d.SORT_CREATED_DESC),value:"CREATED_DESC",selected:"CREATED_DESC"===e},{text:s.t(d.SORT_CREATED_ASC),value:"CREATED_ASC",selected:"CREATED_ASC"===e}];return(0,i.jsx)(n.S,{className:"blur-filter blur-filter-sort",menuStyle:n.K.DROPDOWN,onChange:t,options:r,placeholder:s.t(d.SORT)},void 0)}},99942:(e,t,s)=>{"use strict";if(s.d(t,{_:()=>BlurToolManager}),984==s.j)var i=s(10882);if(984==s.j)var r=s(64781);if(984==s.j)var n=s(75634);if(984==s.j)var a=s(54434);if(984==s.j)var o=s(27326);if(984==s.j)var l=s(49723);if(984==s.j)var d=s(23502);var h=s(13789);if(984==s.j)var c=s(44060);if(984==s.j)var u=s(87182);if(984==s.j)var m=s(28963);if(984==s.j)var g=s(66999);if(984==s.j)var p=s(65379);if(984==s.j)var v=s(35597);if(984==s.j)var f=s(79925);if(984==s.j)var b=s(14576);if(984==s.j)var S=s(81960);if(984==s.j)var C=s(19488);if(984==s.j)var T=s(45003);if(984==s.j)var w=s(7e3);if(984==s.j)var B=s(48410);if(984==s.j)var E=s(79394);if(984==s.j)var y=s(91934);const{SUGGESTIONS:M}=h.Z.WORKSHOP;class BlurToolManager{constructor(e,t){this.engine=e,this.settingsData=t,this.initialized=!1,this.toggledAssets={[y.s]:!1,[g.U]:!1,[c.re]:!1,[u.Mp]:!1,[d.Nj]:!1,[m.s]:!1},this.settingsToggler=new i.u(this.settingsData,this.toggledAssets)}async activate(){if(!this.initialized){this.initialized=!0;const{market:e}=this.engine,[t,s,i,l,d]=await Promise.all([e.waitForData(a.f),e.waitForData(f.H),e.waitForData(o.c),e.waitForData(p.D),e.waitForData(v.O)]),h=new n.Q(t.blurs);let c,u;h.sort(((e,t)=>e.index-t.index)),h.priority=n.K.LOW,this.settingsData.tryGetProperty(w.M,!1)?(c=await e.waitForData(C.a),u=new n.Q(c.suggestions),u.setFilter("accepted",(e=>null===e.accepted)),u.sort(((e,t)=>t.index-e.index))):u=new n.Q(new r.v),this.dataMap={blurData:t,blurEditorData:s,blurList:h,floorsViewData:i,settings:this.settingsData,suggestionData:c,suggestionList:u,sweepViewData:l,viewmodeData:d}}this.settingsToggler.toggle(!0),this.toggleBlurTool(b.t.IDLE)}async deactivate(){this.settingsToggler.toggle(!1),this.toggleBlurTool(b.t.OFF)}async toggleBlurTool(e){this.engine.commandBinder.issueCommand(new S.AQ(e))}async rejectAllSuggestions(){const{suggestionData:e}=this.dataMap;if(!e)return!1;const t=e.getByAccepted(null).map((e=>e.id));if(!t.length)return!1;const s=(0,l.P)(t.length,M.TYPE);return await this.engine.commandBinder.issueCommand(new E.Q(E.f.DISPLAY,s))!==B.U.CLOSE&&(this.engine.commandBinder.issueCommand(new T.oA(...t)),!0)}}},98989:(e,t,s)=>{"use strict";s.d(t,{P:()=>BlurToolUi});var i=s(85893);if(984==s.j)var r=s(94547);if(984==s.j)var n=s(1684);class BlurToolUi{constructor(e,t){this.renderPanel=()=>(0,i.jsx)(n.a,{manager:this.manager},void 0),this.renderActionBar=()=>(0,i.jsx)(r.U,{manager:this.manager},void 0),this.manager=e}}},1684:(e,t,s)=>{"use strict";s.d(t,{a:()=>S});var i=s(85893),r=s(94184),n=s.n(r),a=s(19520),o=s(25813),l=s(66354),d=s(59417),h=s(13789),c=s(12019),u=s(67294),m=s(14576),g=s(81960),p=s(77598),v=s(47491),f=s(33481);const{BLURS:b}=h.Z.WORKSHOP;function S({manager:e,className:t}){const s=(0,l.Z)(e.dataMap.blurList),{commandBinder:r,toolsData:h}=(0,u.useContext)(o.I),S=(0,d.b)(),C=(0,v.y)()===m.t.SUGGESTING,T=n()(t,"blurs-panel"),w=(0,u.useCallback)((e=>{const t=C?m.t.IDLE:m.t.SUGGESTING;r.issueCommand(new g.AQ(t)),e&&e.stopPropagation()}),[C,r]);let B;return B=C?(0,i.jsx)(c.zx,Object.assign({size:c.qE.LARGE,variant:c.Wu.TERTIARY,onClick:w,icon:"back"},{children:S.t(b.CLOSE_SUGGESTIONS)}),void 0):S.t(b.NUM_TYPE,s.length),(0,i.jsxs)(a.L,Object.assign({active:!0,className:T,toolPanelLayout:h.toolPanelLayout,title:B},{children:[C&&(0,i.jsx)(f.w,{className:"blurs-panel-contents",manager:e,onClose:w},void 0),!C&&(0,i.jsx)(p.g,{className:"blurs-panel-contents",manager:e},void 0)]}),void 0)}},71964:(e,t,s)=>{"use strict";s.d(t,{n:()=>m});var i=s(85893);if(984==s.j)var r=s(25813);if(984==s.j)var n=s(59417);var a=s(13789),o=s(12019),l=s(67294);if(984==s.j)var d=s(81960);if(984==s.j)var h=s(14576);if(984==s.j)var c=s(79801);const{BLURS:u}=a.Z.WORKSHOP,m=()=>{const e=(0,c.L)(),{commandBinder:t}=(0,l.useContext)(r.I),s=(0,n.b)(),a=(0,l.useCallback)((()=>{t.issueCommand(new d.AQ(h.t.SUGGESTING))}),[t]);if(!e)return null;const m=s.t(u.SUGGESTIONS_AVAILABLE_MESSAGE,e),g=(0,i.jsxs)(o.zx,Object.assign({size:o.qE.SMALL,variant:o.Wu.SECONDARY,onClick:a,theme:"dark"},{children:[(0,i.jsx)(o.o3,{theme:"dark"},void 0),(0,i.jsx)("span",{children:s.t(u.VIEW_SUGGESTIONS)},void 0)]}),void 0);return(0,i.jsx)(o.jL,{layout:"horizontal",text:m,actions:g,className:"blur-list-banner"},void 0)}},33481:(e,t,s)=>{"use strict";s.d(t,{w:()=>v});var i=s(85893),r=s(94184),n=s.n(r),a=s(12019),o=s(10067),l=s(88118),d=s(16451),h=s(92608),c=s(59417),u=s(13789);const{BLURS:m}=u.Z.WORKSHOP,g=({group:e})=>{const{id:t,title:s,items:r}=e;return(0,i.jsx)(a._m,{id:t,title:`${s} (${r.length})`},void 0)},p=({item:e})=>{const t=(0,c.b)();if(!e){const e=t.t(m.NO_SUGGESTIONS_ON_FLOOR);return(0,i.jsx)(a.gQ,{message:e},void 0)}return(0,i.jsx)(l.e,{suggestion:e},void 0)},v=({className:e,manager:t,onClose:s})=>{const{suggestionList:r}=t.dataMap,l=(0,c.b)(),{groups:u,groupBy:v,setGroupBy:f}=(0,h.l)(r,t);if(!r)return null;const b=n()(e,"suggestion-list"),S=l.t(m.NO_SUGGESTIONS);return(0,i.jsxs)("div",Object.assign({className:b},{children:[(0,i.jsxs)("header",Object.assign({className:"suggestion-list-header"},{children:[(0,i.jsx)(d.a,{manager:t,onClose:s},void 0),(0,i.jsx)(a.w0,{children:(0,i.jsx)(o.nx,{value:v,onChange:f},void 0)},void 0)]}),void 0),(0,i.jsx)("div",Object.assign({className:"suggestion-list-content"},{children:0===u.length?(0,i.jsx)(a.gQ,{message:S,itemHeight:42},void 0):(0,i.jsx)(a.UQ,{data:u,itemHeight:42,renderItem:p,renderGroup:g},void 0)}),void 0)]}),void 0)}},16451:(e,t,s)=>{"use strict";s.d(t,{a:()=>c});var i=s(85893);if(984==s.j)var r=s(25813);var n=s(12019),a=s(67294);if(984==s.j)var o=s(45003);var l=s(13789);if(984==s.j)var d=s(59417);const{BLURS:h}=l.Z.WORKSHOP,c=({onClose:e,manager:t})=>{const s=(0,d.b)(),{commandBinder:l}=(0,a.useContext)(r.I),{suggestionList:c}=t.dataMap,u=(0,a.useCallback)((()=>{l.issueCommand(new o.rf),e()}),[l,e]),m=(0,a.useCallback)((async()=>{await t.rejectAllSuggestions()&&e()}),[t,e]);if(!c)return null;const g=c.length,p=s.t(h.SUGGESTIONS_FOUND_MESSAGE,g),v=(0,i.jsxs)(n.hE,Object.assign({spacing:"small"},{children:[(0,i.jsx)(n.zx,{variant:n.Wu.PRIMARY,size:n.qE.SMALL,onClick:u,label:s.t(h.ACCEPT_ALL_SUGGESTIONS),theme:"dark"},void 0),(0,i.jsx)(n.zx,{variant:n.Wu.TERTIARY,size:n.qE.SMALL,onClick:m,label:s.t(h.REJECT_ALL_SUGGESTIONS),theme:"dark"},void 0)]}),void 0);return(0,i.jsx)("div",Object.assign({className:"suggestion-list-header"},{children:(0,i.jsx)(n.jL,{text:p,actions:v},void 0)}),void 0)}},88118:(e,t,s)=>{"use strict";s.d(t,{e:()=>S});var i=s(85893),r=s(94184),n=s.n(r),a=s(25813),o=s(59417),l=s(13789),d=s(79553),h=s(92532),c=s(12019),u=s(67294),m=s(81960),g=s(45003),p=s(60343),v=s(977),f=s(97523);const{BLURS:b}=l.Z.WORKSHOP,S=({suggestion:e})=>{const{commandBinder:t,toolsData:s}=(0,u.useContext)(a.I),r=(0,o.b)(),l=(0,p.t)(),S=(0,v.z)(),C=(0,f.p)(),T={placement:"top"},w=(0,u.useCallback)((()=>{l&&(l.hoveredBlur=e)}),[e,l]),B=(0,u.useCallback)((()=>{l&&(l.hoveredBlur=null)}),[l]),E=(0,i.jsxs)(c.hE,{children:[(0,i.jsx)(c.zx,{icon:e.visible?"eye-show":"eye-hide",onClick:s=>{e.visible?t.issueCommand(new g.mA(e.id)):t.issueCommand(new g.ee(e.id)),s.stopPropagation()},tooltip:e.visible?r.t(b.HIDE_LIST_ITEM_TOOLTIP_MESSAGE):r.t(b.SHOW_LIST_ITEM_TOOLTIP_MESSAGE),tooltipOptions:T},void 0),(0,i.jsx)(c.zx,{icon:"checkmark",onClick:s=>{t.issueCommand(new g.rf(e.id)),s.stopPropagation()},tooltip:r.t(b.ACCEPT_SUGGESTION_TOOLTIP),tooltipOptions:T},void 0),(0,i.jsx)(c.zx,{icon:"close",onClick:s=>{t.issueCommand(new g.oA(e.id)),s.stopPropagation()},tooltip:r.t(b.REJECT_SUGGESTION_TOOLTIP),tooltipOptions:T},void 0)]},void 0),y=r.t(b.SUGGESTED_BLUR,{number:e.index}),M=n()("suggestion-list-item",{active:C&&C.id===e.id},{hover:S&&S.id===e.id});return(0,i.jsx)(c.HC,{actions:E,className:M,title:y,onClick:()=>{t.issueCommand(new m.mP(e)),s.toolPanelLayout===d.wS.BOTTOM_PANEL&&t.issueCommand(new h.zK(!0))},onMouseEnter:w,onMouseLeave:B},void 0)}},43513:(e,t,s)=>{"use strict";var i;s.d(t,{g:()=>i}),function(e){e.SCANS="scans",e.FLOORS="floors"}(i||(i={}))},60343:(e,t,s)=>{"use strict";if(s.d(t,{t:()=>a}),984==s.j)var i=s(25813);var r=s(67294);if(984==s.j)var n=s(79925);function a(){const{market:e}=(0,r.useContext)(i.I),[t,s]=(0,r.useState)(null);return(0,r.useEffect)((()=>{let t=!1;return e.waitForData(n.H).then((e=>{t||s(e)})),()=>{t=!0}}),[e]),t}},92608:(e,t,s)=>{"use strict";if(s.d(t,{l:()=>c}),984==s.j)var i=s(59417);var r=s(13789),n=s(67294);if(984==s.j)var a=s(43513);const o="other",{BLURS:l,SCANS:d,VIEWS_360:h}=r.Z.WORKSHOP;function c(e,t){const[s,r]=(0,n.useState)(null),[c,u]=(0,n.useState)([]),m=(0,i.b)();return(0,n.useEffect)((()=>{const i=()=>{const i=s===a.g.SCANS?(()=>{const{sweepViewData:s}=t.dataMap,i=s.getAlignedSweeps(!1),r={};if(e){const t=e.groupBy("sweepId");for(const e in t){const n=s.getSweep(e);let a=m.t(d.LIST_ITEM_TEXT,n.index+1);if(!n.isAligned()){const e=i.findIndex((e=>e.id===n.id))||0;a=m.t(h.DEFAULT_NAME,{index:e+1})}r[e]={id:`sweep-${n.id}`,data:n,title:a,items:t[e]}}}return r})():(()=>{const{floorsViewData:s}=t.dataMap,i={};if(e){const t=e.groupBy("floorId");s.floors.iterate((e=>{i[e.id]={id:e.id,data:e,title:e.name,items:t[e.id]||[]}})),t.null&&(i.other={id:o,title:m.t(l.OTHER_GROUP_LABEL),items:t.null})}return i})(),r=Object.values(i).sort(((e,t)=>e.title.localeCompare(t.title,void 0,{numeric:!0})));u(r)},r=[e.onChanged((()=>{i()}))];return i(),()=>{r.forEach((e=>e.cancel()))}}),[e,s,m]),{groups:c,groupBy:null!=s?s:a.g.FLOORS,setGroupBy:r}}},79801:(e,t,s)=>{"use strict";if(s.d(t,{L:()=>a}),984==s.j)var i=s(25813);var r=s(67294);if(984==s.j)var n=s(19488);function a(){const{market:e}=(0,r.useContext)(i.I),[t,s]=(0,r.useState)(0);return(0,r.useEffect)((()=>{const t=[];let i=!1;return e.waitForData(n.a).then((e=>{if(i)return;const r=()=>{s(e.getByAccepted(null).length)};t.push(e.onChanged(r)),r()})),()=>{i=!0,t.forEach((e=>e.cancel()))}}),[e]),t}},47491:(e,t,s)=>{"use strict";s.d(t,{y:()=>a});var i=s(67294);if(984==s.j)var r=s(14576);if(984==s.j)var n=s(60343);function a(){const e=(0,n.t)(),[t,s]=(0,i.useState)(r.t.OFF);return(0,i.useEffect)((()=>{const t=[];if(e){const i=()=>{s(e.toolState)};t.push(e.onPropertyChanged("toolState",i)),i()}return()=>{t.forEach((e=>e.cancel()))}}),[e]),t}},977:(e,t,s)=>{"use strict";s.d(t,{z:()=>n});var i=s(67294);if(984==s.j)var r=s(60343);function n(){const[e,t]=(0,i.useState)(null),s=(0,r.t)();return(0,i.useEffect)((()=>{const e=[];return s&&(e.push(s.onHoveredBlurChanged((e=>t(e)))),t(s.hoveredBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}},97523:(e,t,s)=>{"use strict";s.d(t,{p:()=>n});var i=s(67294);if(984==s.j)var r=s(60343);function n(){const[e,t]=(0,i.useState)(null),s=(0,r.t)();return(0,i.useEffect)((()=>{const e=[];return s&&(e.push(s.onSelectedBlurChanged((e=>t(e)))),t(s.selectedBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}},79925:(e,t,s)=>{"use strict";if(s.d(t,{H:()=>BlurEditorData}),984==s.j)var i=s(32770);if(984==s.j)var r=s(23573);if(984==s.j)var n=s(64781);if(984==s.j)var a=s(84769);if(984==s.j)var o=s(14576);class BlurEditorInteractions extends(984==s.j?r.T:null){constructor(){super(...arguments),this.openedTool=!1,this.createdBlur=!1}}class BlurEditorData extends(984==s.j?i.V:null){constructor(){super(...arguments),this.name="blur-editor",this.toolState=o.t.IDLE,this.brushCursorVisibility=!1,this.interactions=new BlurEditorInteractions,this.showMouseCursor=!1,this.states=new n.v,this._selectedBlur=null,this._hoveredBlur=null}getState(e){let t=this.states.get(e);return t||(t=new a.K,this.states.set(e,t)),t}get selectedBlur(){return this._selectedBlur}set selectedBlur(e){if(this.selectedBlur===e)return;const t=this.selectedBlur;if(this._selectedBlur=e,this.commit(),e){const t=this.getState(e.id);t.selected=!0,t.commit()}if(t){const e=this.getState(t.id);e.selected=!1,e.commit()}}onSelectedBlurChanged(e){return this.onPropertyChanged("_selectedBlur",e)}get hoveredBlur(){return this._hoveredBlur}set hoveredBlur(e){if(this.hoveredBlur===e)return;const t=this.hoveredBlur;if(this._hoveredBlur=e,this.commit(),e){const t=this.getState(e.id);t.hovered=!0,t.commit()}if(t){const e=this.getState(t.id);e.hovered=!1,e.commit()}}onHoveredBlurChanged(e){return this.onPropertyChanged("_hoveredBlur",e)}}},3509:(e,t,s)=>{"use strict";if(s.d(t,{$:()=>BlurEditorModule}),984==s.j)var i=s(2212);if(984==s.j)var r=s(47724);var n=s(96909);if(984==s.j)var a=s(43993);if(984==s.j)var o=s(44283);if(984==s.j)var l=s(75892);if(984==s.j)var d=s(35003);if(984==s.j)var h=s(49340);if(984==s.j)var c=s(88727);if(984==s.j)var u=s(67467);if(984==s.j)var m=s(11369);if(984==s.j)var g=s(54434);if(984==s.j)var p=s(6989);if(984==s.j)var v=s(59088);if(984==s.j)var f=s(4901);if(984==s.j)var b=s(14092);if(984==s.j)var S=s(44019);if(984==s.j)var C=s(35597);if(984==s.j)var T=s(94329);if(984==s.j)var w=s(29422);if(984==s.j)var B=s(31278);if(984==s.j)var E=s(12216);if(984==s.j)var y=s(19674);if(984==s.j)var M=s(66157);if(984==s.j)var I=s(79553);if(984==s.j)var j=s(24151);if(984==s.j)var x=s(23953);if(984==s.j)var D=s(92532);if(984==s.j)var R=s(58891);if(984==s.j)var P=s(23175);if(984==s.j)var O=s(79194);if(984==s.j)var A=s(81960);if(984==s.j)var _=s(79925);if(984==s.j)var L=s(14576);if(984==s.j)var k=s(32306);if(984==s.j)var N=s(88216);if(984==s.j)var G=s(81507);if(984==s.j)var V=s(51433);if(984==s.j)var U=s(57413);if(984==s.j)var F=s(99942);if(984==s.j)var z=s(98989);if(984==s.j)var H=s(78346);if(984==s.j)var Q=s(13789);if(984==s.j)var W=s(33874);if(984==s.j)var Z=s(19488);if(984==s.j)var $=s(7e3);if(984==s.j)var K=s(48602);if(984==s.j)var Y=s(38420);if(984==s.j)var q=s(35026);class BlurEditorModule extends(984==s.j?r.Y:null){constructor(){super(...arguments),this.name="blur_editor",this.activeBindings=[],this.setMeshCursorVisibility=()=>!this.data.hoveredBlur&&this.data.toolState!==L.t.PAINTING,this.changeToolState=e=>{const t=this.data.toolState;e!==t&&(e!==L.t.SUGGESTING||this.config.suggestionsEnabled?(this.data.toolState=e,this.data.commit(),this.onToolStateChange(e,t)):this.log.error("Suggestions not available"))},this.navigateToBlur=e=>{if(!e)throw new Error("Cannot navigate to non-existant blur");let t;const s=this.getFocalPoint(e.dots);if(s){const r=this.sweepData.getSweep(e.sweepId);s.applyQuaternion(r.rotation),t=(0,y.Z)((new i.Quaternion).setFromUnitVectors(E.f.FORWARD,s))}const r=new w.ju({transition:B.n.Interpolate,sweep:e.sweepId,rotation:t});return this.engine.commandBinder.issueCommand(r).then((()=>{this.data.selectedBlur=e||null}))},this.onToolStateChange=(e,t)=>{const{brush:s}=this.data;e!==L.t.OFF&&(this.data.interactions.openedTool||(this.data.interactions.openedTool=!0,this.data.interactions.commit())),t===L.t.PAINTING&&this.engine.commandBinder.issueCommand(new u.o8),e===L.t.PAINTING?(s.enable(),this.engine.broadcast(new M.ps(!1))):(s.disable(),this.engine.broadcast(new M.ps(!0))),e===L.t.OFF?(this.activeBindings.forEach((e=>e.cancel())),this.data.selectedBlur=null,this.data.hoveredBlur=null):this.activeBindings.forEach((e=>e.renew())),e===L.t.SUGGESTING&&this.renderSuggestions(),t===L.t.SUGGESTING&&this.renderBlurs(),this.updatePolling()},this.checkForUpdates=()=>{let e;return(0,o.k1)((()=>{clearInterval(e),e=window.setInterval((()=>{this.log.debug("Polling..."),this.engine.commandBinder.issueCommand(new u.s$)}),1e3*V.F8)}),(()=>{window.clearInterval(e)}),!1)},this.onViewmodeChange=e=>{const{toolState:t}=this.data;e!==T.Ey.Panorama&&t===L.t.PAINTING&&this.changeToolState(L.t.IDLE),e===T.Ey.Panorama?this.clickHandler.renew():this.clickHandler.cancel()},this.onSweepChange=e=>{const{selectedBlur:t}=this.data;t&&(this.onDeselectBlur(t),this.data.selectedBlur=null)},this.onBlursChanged=()=>{const{selectedBlur:e}=this.data;e&&!this.blurData.isEditable(e.id)&&(this.data.selectedBlur=null);const{toolState:t}=this.data;t!==L.t.SUGGESTING&&this.renderBlurs()},this.onSuggestionsChanged=()=>{const e=this.toolData.getTool(I.w1.BLUR);if(e){const t=this.suggestionData.getByAccepted(null).length>0;e.badge!==t&&(e.badge=t,e.commit())}if(!this.data)return;const{toolState:t}=this.data;t===L.t.SUGGESTING&&this.renderSuggestions()},this.onPointerButton=e=>{const{toolState:t}=this.data,{hit:s}=this.raycasterData;e.down&&t===L.t.PAINTING&&this.updateSelectedBlur(s?s.object:null)},this.onKeyEvent=e=>{const{selectedBlur:t}=this.data;if(t&&e.state===N.M.PRESSED)switch(e.key){case G.R.ESCAPE:this.engine.commandBinder.issueCommand(new A.AQ(L.t.IDLE));break;case G.R.DELETE:this.data.selectedBlur&&this.engine.commandBinder.issueCommand(new u.TL(t.id))}},this.onClick=(e,t)=>{const{toolState:s}=this.data;return s===L.t.PAINTING||!!(t instanceof P.$||this.data.selectedBlur)&&(this.updateSelectedBlur(t),!0)},this.onPaint=(e,t,s,i)=>{const r=this.sweepData.currentSweepObject;if(!r)return;let n=this.data.selectedBlur instanceof m.x?this.data.selectedBlur:null;const a=n?n.dotCount:0;(!n||a>V.Vw)&&(n=new m.x({sweepId:r.id}),r.placementType!==q.hU.UNPLACED&&(n.floorId=r.floorId,n.roomId=r.roomId),this.blurData.add(n),this.data.selectedBlur=n);const o=e.clone().applyQuaternion(r.rotation.clone().invert()).normalize();n.add(o,t,s,i)},this.updateHoveredBlur=()=>{const{toolState:e}=this.data,t=this.raycasterData.hit&&this.raycasterData.hit.object,s=e===L.t.PAINTING?null:this.getBlurFromMesh(t);if(s!==this.data.hoveredBlur&&(this.data.hoveredBlur=s,this.data.toolState!==L.t.PAINTING)){const e=s?b.C.FINGER:null;this.engine.commandBinder.issueCommand(new f.u(e))}}}async init(e,t){this.log.debug("Module config",e),this.engine=t,this.config=e,[this.blurData,this.cameraData,this.cursorController,this.raycasterData,this.settings,this.storageData,this.sweepData,this.toolData,this.viewmodeData]=await Promise.all([t.market.waitForData(g.f),t.market.waitForData(v.M_),t.getModuleBySymbol(n.y.CURSOR_CONTROLLER),t.market.waitForData(S.P),t.getModule(a.default),t.market.waitForData(K.Q),t.market.waitForData(l.Z),t.market.waitForData(j.t),t.market.waitForData(C.O)]);const[s,r,o,u]=await Promise.all([t.getModuleBySymbol(n.y.INPUT),t.getModule(k.default),t.market.waitForData(C.O),t.getModuleBySymbol(n.y.WEBGL_RENDERER)]);e.suggestionsEnabled&&(this.suggestionData=await t.market.waitForData(Z.a),this.bindings.push(this.toolData.onChanged(this.onSuggestionsChanged),this.suggestionData.onChanged(this.onSuggestionsChanged)));const m=(await t.getModuleBySymbol(n.y.SWEEP_PANO)).getRenderer();this.data=new _.H,t.market.register(this,_.H,this.data),this.cursorController.addVisibilityRule(this.setMeshCursorVisibility);const p=u.getScene();this.renderer=new O.Z(this.sweepData,this.data,p,s,r,u.cwfRenderer,m),t.addComponent(this,this.renderer);const f=new R.z(this.sweepData,this.cameraData,p,s);f.setSizeRange(V.oR,V.rC),f.onPaint=this.onPaint,t.addComponent(this,f),this.data.brush=f,this.registerSettings(),this.registerTool(),this.clickHandler=s.registerPriorityHandler(d.R,i.Mesh,this.onClick),this.bindings.push(t.commandBinder.addBinding(A.AQ,(async e=>this.changeToolState(e.state))),t.commandBinder.addBinding(A.d8,(async e=>this.data.brush.scale=e.scale)),t.commandBinder.addBinding(A.mP,(async({blur:e})=>this.navigateToBlur(e))),t.commandBinder.addBinding(A.MU,(({ids:e})=>this.showBlurs(...e))),t.commandBinder.addBinding(A.R8,(({ids:e})=>this.hideBlurs(...e))),t.commandBinder.addBinding(A.AB,(async({id:e})=>this.batchToggleVisibility([e]))),t.commandBinder.addBinding(A.$6,(async({ids:e})=>this.batchToggleVisibility(e)))),this.pollingSubscription=this.checkForUpdates(),this.updatePolling(),this.activeBindings.push(o.makeModeChangeSubscription(this.onViewmodeChange),this.sweepData.makeSweepChangeSubscription(this.onSweepChange),this.blurData.blurs.onChanged(this.onBlursChanged),s.registerHandler(h.er,this.onPointerButton),s.registerHandler(c.e,this.onKeyEvent),this.raycasterData.onChanged(this.updateHoveredBlur),this.clickHandler,this.storageData.onPropertyChanged("transactionState",(()=>this.updatePolling())),this.blurData.makeProcessingSubscription((()=>this.updatePolling()))),this.changeToolState(L.t.OFF),this.viewmodeData.currentMode&&this.onViewmodeChange(this.viewmodeData.currentMode),this.renderBlurs(),e.debug&&this.log.info("DEBUG mode enabled")}dispose(e){super.dispose(e),this.pollingSubscription&&this.pollingSubscription.cancel(),e.disposeRenderLayer(this.name),e.market.unregister(this,_.H),this.activeBindings.forEach((e=>e.cancel())),this.cursorController.removeVisibilityRule(this.setMeshCursorVisibility)}renderBlurs(){const e=this.blurData.getByStatus(p.Q.PENDING,p.Q.PROCESSING,p.Q.FAILED).filter((e=>e.visible));this.renderer.setBlurs(e)}renderSuggestions(){const e=this.suggestionData.getByAccepted(!0,null).filter((e=>e.visible));this.renderer.setBlurs(e)}getFocalPoint(e){if(!e.length)return null;let t=0;const s=e.reduce(((e,s)=>{for(const i of s.directions)e.x+=i.x,e.y+=i.y,e.z+=i.z,t++;return e}),{x:0,y:0,z:0});return new i.Vector3(s.x/t,s.y/t,s.z/t)}async showBlurs(...e){this.blurData.setVisibility(!0,...e)}async hideBlurs(...e){this.blurData.setVisibility(!1,...e)}batchToggleVisibility(e){this.blurData.batchToggleVisibility(e)}updatePolling(){const{toolState:e}=this.data,{transactionState:t}=this.storageData,s=e!==L.t.OFF,i=t===Y.g7.IDLE;return s&&i?(this.pollingSubscription.renew(),this.log.debug("Polling enabled"),!0):(this.log.debug("Polling disabled"),this.pollingSubscription.cancel(),!1)}onDeselectBlur(e){const{toolState:t}=this.data;e&&t===L.t.PAINTING&&this.engine.commandBinder.issueCommand(new u.o8)}getBlurFromMesh(e){var t;if(e&&e instanceof P.$){const s=this.data.toolState===L.t.SUGGESTING,i=s?this.suggestionData.get(e.blurId):this.blurData.get(e.blurId);if(s||(null===(t=i)||void 0===t?void 0:t.status)===p.Q.PENDING)return i}return null}updateSelectedBlur(e){const t=this.getBlurFromMesh(e);t!==this.data.selectedBlur&&(this.onDeselectBlur(this.data.selectedBlur),this.data.selectedBlur=t,t&&this.log.debug(`Selected blur ${t.id}`))}registerSettings(){const e="Blur Tool",{brush:t}=this.data,{debug:s,meshBlurEnabled:i,pipelineEnabled:r,suggestionsEnabled:n}=this.config;[{header:e,setting:"blur/brush_size",range:[V.oR,V.rC],initialValue:()=>t.size,onChange:e=>t.size=e},{header:e,setting:"blur/brush_scale",range:[0,1],initialValue:()=>t.scale,onChange:e=>t.scale=e},{header:e,setting:"blur/tool_enabled",initialValue:()=>this.settings.tryGetProperty(V.x3,!1),onChange:e=>this.settings.updateSetting(V.x3,e)},{header:e,setting:"blur/mask",initialValue:()=>!1,onChange:e=>{this.renderer&&this.renderer.setMaskVisibility(e)}},{header:e,setting:"blur/show_cursor",initialValue:()=>!1,onChange:e=>{this.log.debug("Brush mouse cursor "+(e?"enabled":"disabled")),t.toggleMouseCursor(e)}},{header:e,setting:V.Vk,initialValue:()=>s,onChange:e=>{this.settings.updateSetting(V.Vk,e)}},{header:e,setting:V.pv,initialValue:()=>!1,onChange:e=>{this.settings.updateSetting(V.pv,e)}},{header:e,setting:V.n5,initialValue:()=>r,onChange:e=>{this.settings.updateSetting(V.n5,e)}},{header:e,setting:V.i7,initialValue:()=>i,onChange:e=>{this.settings.updateSetting(V.i7,e)}},{header:e,setting:$.M,initialValue:()=>n,onChange:e=>{this.settings.updateSetting($.M,e)}}].forEach((e=>this.settings.registerMenuEntry(e)))}async registerTool(){const{suggestionsEnabled:e}=this.config,t=await this.engine.market.waitForData(W.e);let s,i;e?(i=new F._(this.engine,t),s=new z.P(i,t)):(i=new U._(this.engine,t),s=new H.P(i,t));const r=new x.U({id:I.w1.BLUR,namePhraseKey:Q.Z.TOOLS.BLUR,panel:!0,icon:"icon-blur-outline",analytic:"blur",toolbar:!0,dimmed:!1,enabled:t.tryGetProperty(V.x3,!1),manager:i,ui:s,beta:!1,featureFlag:V.x3,helpMessagePhraseKey:Q.Z.TOOLS.BLUR_HELP_MESSAGE,helpHref:"https://support.matterport.com/hc/en-us/articles/1500003156162-How-to-use-Manual-Blur-Brush"});this.engine.commandBinder.issueCommand(new D.MV([r]))}}},84769:(e,t,s)=>{"use strict";if(s.d(t,{K:()=>BlurEditorState}),984==s.j)var i=s(23573);class BlurEditorState extends(984==s.j?i.T:null){constructor(){super(...arguments),this.selected=!1,this.hovered=!1}}},23175:(e,t,s)=>{"use strict";if(s.d(t,{$:()=>BlurMesh}),984==s.j)var i=s(2212);class BlurMesh extends(984==s.j?i.InstancedMesh:null){}},60615:(e,t,s)=>{"use strict";s.d(t,{J:()=>BlurOverlayRenderer});var i=s(2212);if(984==s.j)var r=s(10941);if(984==s.j)var n=s(51433);const a=new i.Matrix4;function o(e){const t=new i.WebGLCubeRenderTarget(e,{format:i.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1});return t.texture.image={},t.texture.image.width=e,t.texture.image.height=e,t}class BlurRenderTarget{constructor(e,t,s){this.inputSize=e,this.outputSize=t,this.sigma=s,this.input=o(e),this.output=o(t)}get texture(){return this.output.texture}}class BlurOverlayRenderer{constructor(e,t){this.renderToTexture=e,this.renderer=t,this.renderTarget=new i.WebGLCubeRenderTarget(2048,{format:i.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1}),this.camera=new i.Camera,this.blurRTs=n.TW.map((e=>((e,t,s)=>{const r=new BlurRenderTarget(e,t,s);return{renderTarget:r,cubeCamera:new i.CubeCamera(.1,1e3,r.output)}})(e.size,2*e.size,e.sigma))),this.debug={};const s=i.UniformsUtils.clone(r.Z.combineBlurs.uniforms);this.material=new i.RawShaderMaterial({fragmentShader:r.Z.combineBlurs.fragmentShader,vertexShader:r.Z.combineBlurs.vertexShader,uniforms:s,side:i.DoubleSide,name:"CubemapRendererMaterial"}),this.mesh=new i.Mesh(new i.BoxBufferGeometry(100,100,100),this.material),this.material.uniforms.panoBlurredMap0.value=this.blurRTs[0].renderTarget.texture,this.material.uniforms.panoBlurredMap1.value=this.blurRTs[1].renderTarget.texture,this.material.uniforms.panoBlurredMap2.value=this.blurRTs[2].renderTarget.texture,this.material.uniforms.panoBlurredMap3.value=this.blurRTs[3].renderTarget.texture,this.renderTarget.texture.image={},this.renderTarget.texture.image.height=2048,this.renderTarget.texture.image.width=2048}setDebug(e,t){t?this.debug[e]=!0:this.debug[e]&&delete this.debug[e],this.material.defines=this.debug,this.material.needsUpdate=!0,this.render()}render(){this.renderToTexture.render(this.renderTarget,this.mesh,this.camera)}get texture(){return this.renderTarget.texture}setMaskTexture(e,t=a){this.material.uniforms.maskTexture.value=e,this.material.uniforms.maskMatrix.value.copy(t)}setPano(e,t,s=a,i=a){if(e!==this.currentSweepId||this.currentPanoTexture!==t){this.currentSweepId=e,this.currentPanoTexture=t;for(const e of this.blurRTs){const s=e.renderTarget,i=.5/s.input.width;this.renderer.copyCubemap(t,s.input),this.renderer.blurCubemap(s.input.texture,e.cubeCamera,s.sigma,i)}this.material.uniforms.panoMatrix1.value.copy(s),this.material.uniforms.panoMatrix2.value.copy(i)}}}},79194:(e,t,s)=>{"use strict";if(s.d(t,{Z:()=>BlurRenderer}),984==s.j)var i=s(43993);if(984==s.j)var r=s(84303);if(984==s.j)var n=s(48358);if(984==s.j)var a=s(12216);if(984==s.j)var o=s(51858);if(984==s.j)var l=s(87202);if(984==s.j)var d=s(29397);var h=s(2212);if(984==s.j)var c=s(23175);if(984==s.j)var u=s(60615);if(984==s.j)var m=s(14576);if(984==s.j)var g=s(32893);const p=new h.Color(16711680),v=new h.Color(65280),f=new h.Color(255);class BlurRenderer{constructor(e,t,s,i,n,a,d){this.sweepData=e,this.blurEditorData=t,this.scene=s,this.input=i,this.panoRenderer=d,this.root=new h.Group,this.meshes={},this.maskRenderTarget=new h.WebGLCubeRenderTarget(1024,{format:h.RGBFormat,generateMipmaps:!1}),this.maskCamera=new h.Camera,this.maskBackground=new h.Mesh(new h.BoxGeometry(10,10,10),new h.MeshBasicMaterial({color:0,side:h.DoubleSide})),this.maskVisible=!1,this.dirty=!0,this.updating=!1,this.bindings=[],this.blurs=[],this.renderBlurredOverlay=(()=>{const e=new h.Matrix4,t=new h.Matrix4,s=new h.Quaternion;return async i=>{this.maskCamera.position.copy(i.position),this.maskBackground.position.copy(i.position),await this.engine.commandBinder.issueCommand(new l.sp(this.maskRenderTarget,this.root,this.maskCamera));const n=this.maskRenderTarget.texture,a=this.panoRenderer.useTexture(i.id);e.makeRotationFromQuaternion(s.copy(i.rotation).invert()),t.makeScale(-1,1,1),this.overlayRenderer.setPano(i.id,a,e,t),this.overlayRenderer.setMaskTexture(n),this.overlayRenderer.render(),this.panoRenderer.freeTexture(i.id),await this.engine.after(r.A.Begin),await this.engine.commandBinder.issueCommand(new o.M(i.id,this.overlayRenderer.texture,new h.Quaternion))}})(),this.currentSweep=this.sweepData.currentSweepObject||null,this.overlayRenderer=new u.J(n,a)}setBlurs(e){this.blurs!==e&&(this.blurs=e,this.dirty=!0)}init(){this.root.add(this.maskBackground)}async activate(e){const[t]=await Promise.all([e.getModule(i.default)]);this.engine=e,this.meshes={},this.bindings.push(this.blurEditorData.onChanged((()=>this.dirty=!0))),this.bindings.push(e.subscribe(d.Z,(e=>{this.currentSweep=this.sweepData.getSweep(e.toSweep),this.dirty=!0}))),t.registerButton("Blur Debug","Toggle blur level coloration",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_COLORS",!this.overlayRenderer.debug.DEBUG_BLUR_COLORS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),t.registerButton("Blur Debug","Toggle blur test",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_LEVELS",!this.overlayRenderer.debug.DEBUG_BLUR_LEVELS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),this.maskRenderTarget.texture.image={},this.maskRenderTarget.texture.image.width=1024,this.maskRenderTarget.texture.image.height=1024}dispose(){this.root.traverse((e=>{e instanceof h.Mesh&&e.geometry.dispose()}))}render(){this.dirty&&!this.updating&&(this.updating=!0,this.dirty=!1,this.update().finally((()=>{this.updating=!1})))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}getBlursForSweep(e){return this.blurs.filter((t=>t.sweepId===e))}async update(){var e,t,s,i;if(!this.currentSweep)return;const r=this.currentSweep,o=this.getBlursForSweep(r.id),l={};for(const e of o)for(const[t,s]of e.dots.entries())l[`${e.id}-${t}`]=s;let d=!1;for(const e in this.meshes){const t=this.meshes[e];l[e]&&l[e].directions.length===t.count||(this.root.remove(t),this.input.unregisterMesh(t),delete this.meshes[e],d=!0)}const u=new h.Vector3,S=new h.Vector3,C=new h.Vector3,T=new h.Matrix4,w=new h.Vector3;for(const e of o)for(const[t,s]of e.dots.entries()){const i=`${e.id}-${t}`;if(0===s.directions.length||this.meshes[i])continue;u.set(s.radius,s.radius-s.feather,s.radius),S.set(s.feather,s.feather,s.feather),C.set(s.strength,1,s.strength);const n=new g.w(u,S,C,{defines:{USE_INSTANCING:!0},depthTest:!1,depthWrite:!1}),o=new c.$(new h.PlaneBufferGeometry(1,1),n,s.directions.length);o.blurId=e.id,s.directions.forEach(((e,t)=>{const i=2*(s.radius+s.feather),n=b(e,r);T.lookAt(r.position,n,a.f.UP),T.scale(w.set(i,i,i)),T.setPosition(n),o.setMatrixAt(t,T)})),this.meshes[i]=o,this.root.add(o),this.input.registerMesh(o,!1),d=!0}const B=new h.Color,{toolState:E,selectedBlur:y,hoveredBlur:M}=this.blurEditorData;for(const r in this.meshes){const a=this.meshes[r],o=a.material;B.copy(p);let l=n.z.reticule+.1;const h=null===(t=null===(e=M)||void 0===e?void 0:e.editable)||void 0===t||t,c=null===(i=null===(s=y)||void 0===s?void 0:s.editable)||void 0===i||i;E!==m.t.PAINTING&&(h&&a.blurId===(null==M?void 0:M.id)&&(B.add(f),l=n.z.reticule+.2),c&&a.blurId===(null==y?void 0:y.id)&&(B.add(v),l=n.z.reticule+.3)),o.color.equals(B)&&a.renderOrder===l||(o.color.copy(B),a.renderOrder=l,d=!0)}d&&await this.renderBlurredOverlay(r)}setMaskVisibility(e){this.maskVisible!==e&&(e?this.scene.add(this.root):this.scene.remove(this.root),this.maskVisible=e)}}function b(e,t){const s=e.clone().applyQuaternion(t.rotation).normalize();return t.position.clone().add(s)}},14576:(e,t,s)=>{"use strict";var i;s.d(t,{t:()=>i}),function(e){e.OFF="off",e.IDLE="idle",e.PAINTING="painting",e.SUGGESTING="suggesting"}(i||(i={}))},78346:(e,t,s)=>{"use strict";s.d(t,{P:()=>BlurToolUi});var i=s(85893);if(984==s.j)var r=s(61119);if(984==s.j)var n=s(83714);if(984==s.j)var a=s(94547);if(984==s.j)var o=s(51805);class BlurToolUi{constructor(e,t){this.renderPanel=()=>{const e=this.settings.tryGetProperty(o.x,!1)&&this.settings.tryGetProperty(r.$,!1);return(0,i.jsx)(n.I,{manager:this.manager,batchSelectEnabled:e},void 0)},this.renderActionBar=()=>(0,i.jsx)(a.U,{manager:this.manager},void 0),this.manager=e,this.settings=t}}},32893:(e,t,s)=>{"use strict";if(s.d(t,{w:()=>BrushMaterial}),984==s.j)var i=s(2212);if(984==s.j)var r=s(10941);class BrushMaterial extends(984==s.j?i.RawShaderMaterial:null){constructor(e,t,s,n){const a=i.UniformsUtils.clone(r.Z.brush.uniforms);a.radius.value.copy(e),a.feather.value.copy(t),a.opacity.value.copy(s),a.color.value.set(1,0,0),super(Object.assign(Object.assign({},n),{fragmentShader:r.Z.brush.fragmentShader,vertexShader:r.Z.brush.vertexShader,uniforms:a,side:i.FrontSide,transparent:!0,blending:i.AdditiveBlending,name:"brushMaterial"}))}get color(){return this.uniforms.color.value}set color(e){this.uniforms.color.value=e}}},81960:(e,t,s)=>{"use strict";if(s.d(t,{AQ:()=>BlurToolChangeCommand,d8:()=>SetBlurBrushScaleCommand,mP:()=>NavigateToBlurCommand,AB:()=>ToggleBlurVisibilityCommand,MU:()=>ShowBlursCommand,R8:()=>HideBlursCommand,$6:()=>BatchToggleBlurVisibilityCommand}),984==s.j)var i=s(17386);class BlurToolChangeCommand extends(984==s.j?i.m:null){constructor(e){super(),this.id="BLUR_TOOL_CHANGE",this.payload={state:e}}}class SetBlurBrushScaleCommand extends(984==s.j?i.m:null){constructor(e){super(),this.id="SET_BLUR_BRUSH_SCALE",this.payload={scale:e}}}class NavigateToBlurCommand extends(984==s.j?i.m:null){constructor(e){super(),this.id="NAVIGATE_TO_BLUR",this.payload={blur:e}}}class ToggleBlurVisibilityCommand extends(984==s.j?i.m:null){constructor(e){super(),this.id="TOGGLE_BLUR_VISIBILITY",this.payload={id:e}}}class ShowBlursCommand extends(984==s.j?i.m:null){constructor(...e){super(),this.id="SHOW_BLURS",this.payload={ids:e}}}class HideBlursCommand extends(984==s.j?i.m:null){constructor(...e){super(),this.id="HIDE_BLURS",this.payload={ids:e}}}class BatchToggleBlurVisibilityCommand extends(984==s.j?i.m:null){constructor(e){super(),this.id="BATCH_TOGGLE_BLUR_VISIBILITY",this.payload={ids:e}}}},38040:(e,t,s)=>{"use strict";if(s.r(t),s.d(t,{BatchToggleBlurVisibilityCommand:()=>i.$6,BlurToolChangeCommand:()=>i.AQ,HideBlursCommand:()=>i.R8,NavigateToBlurCommand:()=>i.mP,SetBlurBrushScaleCommand:()=>i.d8,ShowBlursCommand:()=>i.MU,ToggleBlurVisibilityCommand:()=>i.AB,BlurToolState:()=>r.t,default:()=>n.$}),984==s.j)var i=s(81960);if(984==s.j)var r=s(14576);if(984==s.j)var n=s(3509)},51433:(e,t,s)=>{"use strict";s.d(t,{x3:()=>r,Vk:()=>n,n5:()=>a,i7:()=>o,pv:()=>l,TW:()=>d,F8:()=>h,oR:()=>c,rC:()=>u,Vw:()=>m,Dr:()=>g});var i=s(98612);const r="tools/blur_editor",n="blur_debug",a="blur_pipeline",o="blur_mesh",l="blur_chunks",d=[{size:256,sigma:5},{size:128,sigma:5},{size:64,sigma:5},{size:32,sigma:5}],h=60,c=.01,u=.25,m=1e3,g=(0,i.fp)("mp/test-max-blurs-limit",80)},10941:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var i=s(20855),r=s(2212),n=s(31090),a=s(69383);const o={brush:{uniforms:{opacity:{type:"v3",value:new r.Vector3(1,1,1)},color:{type:"c",value:new r.Color},radius:{type:"v3",value:new r.Vector3(.1,.1,.1)},feather:{type:"v3",value:new r.Vector3(0,0,0)}},vertexShader:(0,i.m)(a,s(31530)),fragmentShader:(0,i.m)(n,s(1833))},combineBlurs:{uniforms:{maskMatrix:{type:"m4",value:new r.Matrix4},maskTexture:{type:"t",value:null},panoMatrix1:{type:"m4",value:new r.Matrix4},panoMatrix2:{type:"m4",value:new r.Matrix4},panoBlurredMap0:{type:"t",value:null},panoBlurredMap1:{type:"t",value:null},panoBlurredMap2:{type:"t",value:null},panoBlurredMap3:{type:"t",value:null}},vertexShader:(0,i.m)(a,s(22627)),fragmentShader:(0,i.m)(n,s(24294))}}},11846:(e,t,s)=>{"use strict";if(s.d(t,{P:()=>BlurSuggestion}),984==s.j)var i=s(23573);if(984==s.j)var r=s(10757);class BlurSuggestion extends(984==s.j?i.T:null){constructor(e){super(),this.accepted=null,this.index=-1,this.classification=[],this.visible=!0,this.id=(0,r.O1)(11),e&&Object.assign(this,e)}}},19488:(e,t,s)=>{"use strict";if(s.d(t,{a:()=>BlurSuggestionData}),984==s.j)var i=s(32770);if(984==s.j)var r=s(64781);if(984==s.j)var n=s(10757);class BlurSuggestionData extends(984==s.j?i.V:null){constructor(e){super(),this.name="blur-suggestion-data",this.suggestions=new r.v,e&&this.add(...e)}add(...e){this.suggestions.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.suggestions.has(t.id);)t.id=(0,n.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.suggestions.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.suggestions.set(t.id,t)})),this.commit()}has(e){return this.suggestions.has(e)}hasIndex(e){return!!this.suggestions.values.find((t=>t.index===e))}get(e){return this.suggestions.get(e)}getByAccepted(...e){return this.suggestions.values.filter((t=>e.includes(t.accepted)))}getSuggestionCount(){return this.suggestions.length}accept(...e){return this.updateAll(e,{accepted:!0})}reject(...e){return this.updateAll(e,{accepted:!1})}reset(...e){return this.updateAll(e,{accepted:null})}show(...e){return this.updateAll(e,{visible:!0})}hide(...e){return this.updateAll(e,{visible:!1})}updateAll(e,t){const s=e.length?e:this.suggestions.keys;this.atomic((()=>{this.suggestions.atomic((()=>{for(const e of s)if(this.has(e)){const s=this.get(e);Object.assign(s,t),s.commit()}})),this.commit()}))}}},70761:(e,t,s)=>{"use strict";if(s.d(t,{n:()=>BlurSuggestionsModule}),984==s.j)var i=s(47724);if(984==s.j)var r=s(43993);if(984==s.j)var n=s(39729);if(984==s.j)var a=s(71194);if(984==s.j)var o=s(57361);if(984==s.j)var l=s(54434);if(984==s.j)var d=s(11369);if(984==s.j)var h=s(67467);if(984==s.j)var c=s(26587);if(984==s.j)var u=s(50988);if(984==s.j)var m=s(38420);if(984==s.j)var g=s(41029);if(984==s.j)var p=s(75892);var v=s(20331);if(984==s.j)var f=s(68223);if(984==s.j)var b=s(19488);if(984==s.j)var S=s(45003);if(984==s.j)var C=s(50106);if(984==s.j)var T=s(14608);if(984==s.j)var w=s(20880);class BlurSuggestionsModule extends(984==s.j?i.Y:null){constructor(){super(...arguments),this.name="blur-suggestions"}async init(e,t){this.engine=t,this.config=e,this.load(),this.registerSettings()}async load(){const{baseUrl:e,modelId:t,queue:s,readonly:i,source:r,importEnabled:a}=this.config,{market:d,commandBinder:h}=this.engine,[g,v]=await Promise.all([d.waitForData(l.f),d.waitForData(p.Z)]);this.blurData=g,this.store=new T.e({queue:s,baseUrl:e,modelId:t,sweepData:v}),this.data=new b.a;let f=[];if(r===C.Z.VISION?(this.log.info("Loading suggestions from Vision, changes will NOT be saved"),this.config.readonly=!0,this.config.importEnabled=!1,f=await this.getSuggestionsFromVision()):(f=await this.store.read(),this.log.debug("Loaded existing suggestions",f)),this.data.add(...f||[]),!i){const e=await this.engine.getModule(c.F);this.bindings.push(h.addBinding(S.qY,(()=>h.issueCommand(new u.VQ({dataTypes:[m.g.BLUR_SUGGESTIONS]})))),h.addBinding(S.rf,(({ids:e})=>this.accept(...e))),h.addBinding(S.oA,(({ids:e})=>this.reject(...e))),h.addBinding(S.ee,(({ids:e})=>this.show(...e))),h.addBinding(S.mA,(({ids:e})=>this.hide(...e))),e.onSave((()=>this.save()),{dataType:m.g.BLUR_SUGGESTIONS}))}if(d.register(this,b.a,this.data),i||(this.monitor=new o.c(this.data.suggestions,{aggregationType:n.E.Manual})),a&&!this.data.getSuggestionCount()){const e=await this.getSuggestionsFromVision();this.data.add(...e),this.log.debug(`Importing ${e.length} suggestions from Vision...`),h.issueCommand(new S.qY)}}dispose(e){super.dispose(e),e.market.unregister(this,b.a)}async accept(...e){const{commandBinder:t}=this.engine,s=e.length?e.map((e=>this.data.get(e))):this.data.getByAccepted(null),i=s.map((e=>d.x.from(e)));return this.blurData.add(...i),this.data.accept(...s.map((e=>e.id))),Promise.all([t.issueCommand(new h.o8),t.issueCommand(new S.qY)]).then((()=>{}))}async reject(...e){const{commandBinder:t}=this.engine,s=e.length?e:this.data.getByAccepted(null).map((e=>e.id));return this.data.reject(...s),t.issueCommand(new S.qY)}async show(...e){this.data.show(...e)}async hide(...e){this.data.hide(...e)}async save(){const{readonly:e}=this.config;if(e||!this.monitor)return;this.monitor.commitChanges();const t=this.monitor.getDiffRecord();if(this.monitor.clearDiffRecord(),!t.length)return;const s={};for(const e of t)switch(e.action){case a.KI.added:case a.KI.updated:s[e.index]=this.data.get(e.index);break;case a.KI.removed:s[e.index]=null}return this.store.update(s).catch((e=>{this.log.error(e)}))}async getSuggestionsFromVision(){const{market:e}=this.engine,[t,s]=await Promise.all([e.waitForData(f.R),e.waitForData(p.Z)]);let i=null;const r=t.objectBlur;if(null==r?void 0:r.url){const e=new g.K({url:r.url,queue:this.config.queue||new v.RequestQueue,format:"json",deserializer:(0,w.J)(s)});i=await e.read()}return i||[]}async registerSettings(){const e=await this.engine.getModule(r.default),{debug:t}=this.config;t&&e.registerMenuButton({header:"Blur Suggestions",buttonName:"Reset Suggestions",callback:()=>{this.store.reset()}})}}},45003:(e,t,s)=>{"use strict";if(s.d(t,{qY:()=>SaveSuggestionsCommand,ee:()=>ShowSuggestionsCommand,mA:()=>HideSuggestionsCommand,rf:()=>AcceptSuggestionsCommand,oA:()=>RejectSuggestionsCommand}),984==s.j)var i=s(17386);class SaveSuggestionsCommand extends(984==s.j?i.m:null){constructor(){super(...arguments),this.id="SAVE_BLUR_SUGGESTIONS"}}class ShowSuggestionsCommand extends(984==s.j?i.m:null){constructor(...e){super(),this.id="SHOW_BLUR_SUGGESTIONS",this.payload={ids:e}}}class HideSuggestionsCommand extends(984==s.j?i.m:null){constructor(...e){super(),this.id="HIDE_BLUR_SUGGESTIONS",this.payload={ids:e}}}class AcceptSuggestionsCommand extends(984==s.j?i.m:null){constructor(...e){super(),this.id="ACCEPT_BLUR_SUGGESTIONS",this.payload={ids:e}}}class RejectSuggestionsCommand extends(984==s.j?i.m:null){constructor(...e){super(),this.id="REJECT_BLUR_SUGGESTIONS",this.payload={ids:e}}}},50106:(e,t,s)=>{"use strict";var i;s.d(t,{Z:()=>i}),function(e){e.AUTO="auto",e.JSONSTORE="jsonstore",e.VISION="vision"}(i||(i={}))},17745:(e,t,s)=>{"use strict";if(s.r(t),s.d(t,{BlurSuggestionData:()=>i.a,default:()=>r.n}),984==s.j)var i=s(19488);if(984==s.j)var r=s(70761)},7e3:(e,t,s)=>{"use strict";s.d(t,{M:()=>i,$:()=>r});const i="blur_suggestions",r="blur_suggestions_import"},14608:(e,t,s)=>{"use strict";if(s.d(t,{e:()=>BlurSuggestionStore}),984==s.j)var i=s(38330);if(984==s.j)var r=s(96205);if(984==s.j)var n=s(11067);class BlurSuggestionStore extends(984==s.j?i.MU:null){constructor(e){const{queue:t,baseUrl:s,modelId:i,sweepData:a}=e;super({queue:t,path:`${s}/api/v1/jsonstore/model/blur-suggestions/${i}`,batchUpdate:!0,deserialize:(0,r.W)(a),serialize:(0,n.s)(a)}),this.baseUrl=s,this.modelId=i}async read(){const e=await super.read();return Object.values(e||{})}async reset(){var e;const{queue:t}=this.config,s=`${this.baseUrl}/api/v1/jsonstore/model/blur-suggestions/${this.modelId}`;if(!(null===(e=this.modelId)||void 0===e?void 0:e.length))throw new Error(`Refusing to DELETE ${s}`);if(window.confirm("Are you sure you want to reset all suggestions? This cannot be undone."))return t.delete(s,this.options).then((()=>{window.location.reload()}))}}},96205:(e,t,s)=>{"use strict";if(s.d(t,{W:()=>l}),984==s.j)var i=s(11846);if(984==s.j)var r=s(59838);var n=s(88512);if(984==s.j)var a=s(31879);const o=new n.Z("blurSuggestionDeserializer");function l(e){const t=function(e){return function(t){const s=(0,r.LB)(null==t?void 0:t.dots),n=e.getSweepByUuid(null==t?void 0:t.sweepId);if(!(t&&s&&s.length&&n))return o.debug("Deserialized invalid Blur suggestion",t),null;const l=!0===t.accepted||!1===t.accepted?t.accepted:null;return new i.P({id:t.sid,accepted:l,dots:s,index:t.index,floorId:n.floorId,roomId:n.roomId,sweepId:n.id,classification:t.tags||[],visible:!0,created:(0,a.p)(t.created),modified:(0,a.p)(t.modified)})}}(e);return function(e){const s={};for(const i in e){const r=t(e[i]);r&&(s[i]=r)}return s}}},11067:(e,t,s)=>{"use strict";if(s.d(t,{s:()=>n}),984==s.j)var i=s(2445);if(984==s.j)var r=s(31879);function n(e){const t=function(e){return function(t){const s=e.getSweep(t.sweepId),n=(0,i.o_)(t.dots);return s&&(null==n?void 0:n.length)?{sid:t.id,accepted:t.accepted,dots:n,index:t.index,sweepId:s.uuid,tags:t.classification,visible:t.visible,created:(0,r.U)(t.created),modified:(0,r.U)(t.modified)}:null}}(e);return function(e){const s={};for(const i in e){const r=t(e[i]);r&&(s[i]=r)}return s}}},20880:(e,t,s)=>{"use strict";if(s.d(t,{J:()=>n}),984==s.j)var i=s(59838);if(984==s.j)var r=s(11846);function n(e){return t=>{const s=[];if(!(null==t?void 0:t.blurs))return[];const n=Object.values(t.blurs).filter((e=>!e.blurEnabled));for(const t of n){const n=e.getSweepByUuid(t.sweepId),a=(0,i.LB)(t.dots);if(!(null==a?void 0:a.length)||!n||!Array.isArray(null==t?void 0:t.dots))continue;const o=new r.P({accepted:null,sweepId:n.id,dots:a,classification:["face"],floorId:n.floorId||void 0,visible:!0});s.push(o)}return s}}},41421:(e,t,s)=>{"use strict";var i;s.d(t,{e:()=>i}),function(e){e.DISABLED="disabled",e.IDLE="idle",e.PAINTING="painting"}(i||(i={}))},58891:(e,t,s)=>{"use strict";if(s.d(t,{z:()=>PanoBrush}),984==s.j)var i=s(2212);if(984==s.j)var r=s(84561);if(984==s.j)var n=s(48358);if(984==s.j)var a=s(4901);if(984==s.j)var o=s(14092);if(984==s.j)var l=s(27408);if(984==s.j)var d=s(19674);var h=s(88512);if(984==s.j)var c=s(51869);if(984==s.j)var u=s(49340);if(984==s.j)var m=s(35003);if(984==s.j)var g=s(27687);if(984==s.j)var p=s(49540);if(984==s.j)var v=s(17490);if(984==s.j)var f=s(48715);if(984==s.j)var b=s(41421);if(984==s.j)var S=s(57159);const C=new h.Z("pano-brush");class PanoBrush{constructor(e,t,s,l,h=r.o.ALL){this.sweepData=e,this.cameraData=t,this.scene=s,this.input=l,this.cameraVector=new i.Vector3,this.lastPaint=new i.Vector3,this.mouseCursorEnabled=!1,this.needsUpdate=!0,this.observables={size:new f.f(.1),scale:new f.f(.2),feather:new f.f(.1),pressure:new f.f(.1),opacity:new f.f(1),state:new f.f(b.e.DISABLED)},this.position=new i.Vector3,this.direction=new i.Vector3,this.sizeRange=[.1,.5],this.featherRange=[.005,.125],this.pressureRange=[.0063,.0125],this.onPointerButton=e=>e.down?this.startPainting():this.stopPainting(),this.onPointerMove=e=>{const t=(0,g.st)(this.cameraData,e.position);if(this.setPosition(t),this.state===b.e.PAINTING&&this.onPaint){const e=(0,d.et)(this.observables.size.value,this.sizeRange[0],this.sizeRange[1],.005,.03);if(this.lastPaint.length()>0){const t=this.direction.clone().sub(this.lastPaint).setLength(e),s=this.lastPaint.clone();for(;s.angleTo(this.direction)>e;)s.add(t).normalize(),this.lastPaint.copy(s),this.onPaint(s,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}else this.lastPaint.copy(this.direction),this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}},this.onClick=e=>{const t=(0,g.st)(this.cameraData,e.position);this.setPosition(t),this.onPaint&&this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)},this.onMouseMove=e=>{const{tagName:t}=e.target||{},s=this.mouseCursorEnabled||!t||"CANVAS"!==t?null:o.C.NONE;s!==this.mouseCursor&&(this.engine.commandBinder.issueCommand(new a.u(s)),this.mouseCursor=s)},this.brushCursor=new S.e,this.brushCursor.renderOrder=n.z.reticule,this.brushCursor.layers.mask=h.mask}init(){this.bindings=new v.V(this.input.registerPriorityHandler(c._t,i.Mesh,(()=>!0)),this.input.registerHandler(u.mE,this.onPointerMove),this.input.registerHandler(u.er,this.onPointerButton),this.input.registerUnfilteredHandler(m.R,this.onClick),new p.r(document.body,"mousemove",this.onMouseMove)),this.bindings.cancel()}render(){this.state!==b.e.DISABLED&&this.needsUpdate&&(this.brushCursor.position.copy(this.position),this.brushCursor.lookAt(this.scene.camera.getWorldPosition(this.cameraVector)),this.needsUpdate=!1)}dispose(){this.brushCursor.dispose()}activate(e){this.engine=e}deactivate(e){this.disable()}enable(){C.debug("Enabled"),this.observables.state.value=b.e.IDLE,this.bindings.renew(),this.scene.add(this.brushCursor)}disable(){C.debug("Disabled"),this.observables.state.value=b.e.DISABLED,this.bindings.cancel(),this.scene.remove(this.brushCursor),this.engine.commandBinder.issueCommand(new a.u(null))}onPropertyChanged(e,t){return this.observables[e].onChanged(t)}getSizeRange(){return this.sizeRange}setSizeRange(e,t){this.sizeRange=[e,t],this.scale=this.observables.scale.value}get scale(){return this.observables.scale.value}set scale(e){const t=(0,l.uZ)(e,0,1),s=(0,d.dS)(t,0,1,this.sizeRange[0],this.sizeRange[1]),i=(0,d.dS)(t,0,1,this.featherRange[0],this.featherRange[1]),r=(0,d.dS)(t,0,1,this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=s,this.observables.size.value=s,this.observables.scale.value=t,this.observables.feather.value=i,this.observables.pressure.value=r,C.debug(`Set brush scale to ${100*t}% (${s})`)}get state(){return this.observables.state.value}get size(){return this.observables.size.value}set size(e){const t=(0,l.uZ)(e,this.sizeRange[0],this.sizeRange[1]),s=(0,d.dS)(t,this.sizeRange[0],this.sizeRange[1],0,1),i=(0,d.dS)(t,this.sizeRange[0],this.sizeRange[1],this.featherRange[0],this.featherRange[1]),r=(0,d.dS)(t,this.sizeRange[0],this.sizeRange[1],this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=t,this.observables.size.value=t,this.observables.scale.value=s,this.observables.feather.value=i,this.observables.pressure.value=r,C.debug(`Set brush size to ${t} (${100*s}%)`)}toggleMouseCursor(e){this.mouseCursorEnabled=e}startPainting(){this.observables.state.value=b.e.PAINTING}stopPainting(){this.observables.state.value=b.e.IDLE,this.lastPaint.set(0,0,0)}setPosition(e){const t=this.sweepData.currentSweepObject;if(!t)return;const s=e.clone().sub(t.position).normalize(),i=t.position.clone().add(s);this.position.copy(i),this.direction.copy(s),this.needsUpdate=!0}}},57159:(e,t,s)=>{"use strict";if(s.d(t,{e:()=>SphereBrushCursor}),984==s.j)var i=s(2212);if(984==s.j)var r=s(48358);class SphereBrushCursor extends(984==s.j?i.Object3D:null){constructor(){super(),this._radius=.1,this._thickness=.005,this.name="SphereBrushCursor";const e=new i.MeshBasicMaterial({color:16777215,side:i.DoubleSide,depthTest:!1,transparent:!0}),t=this.getGeometry();this.mesh=new i.Mesh(t,e),this.mesh.renderOrder=r.z.reticule,this.add(this.mesh)}getGeometry(){return new i.RingGeometry(this._radius,this._radius+this._thickness,64)}updateCursorMesh(){this.mesh.geometry.dispose(),this.mesh.geometry=this.getGeometry()}get radius(){return this._radius}set radius(e){this._radius=e,this.updateCursorMesh()}dispose(){this.mesh.material.dispose(),this.mesh.geometry.dispose()}}},91215:(e,t,s)=>{"use strict";if(s.d(t,{M:()=>RenameFloorCommand}),984==s.j)var i=s(17386);class RenameFloorCommand extends(984==s.j?i.m:null){constructor(e,t){super(),this.id="RENAME_FLOOR",this.payload={floorId:e,text:t}}}},57413:(e,t,s)=>{"use strict";if(s.d(t,{_:()=>BlurToolManager}),984==s.j)var i=s(35597);if(984==s.j)var r=s(81960);if(984==s.j)var n=s(14576);if(984==s.j)var a=s(79925);if(984==s.j)var o=s(54434);if(984==s.j)var l=s(65379);if(984==s.j)var d=s(27326);if(984==s.j)var h=s(91934);if(984==s.j)var c=s(66999);if(984==s.j)var u=s(44060);if(984==s.j)var m=s(23502);if(984==s.j)var g=s(28963);if(984==s.j)var p=s(87182);if(984==s.j)var v=s(10882);if(984==s.j)var f=s(75634);class BlurToolManager{constructor(e,t){this.engine=e,this.settingsData=t,this.initialized=!1,this.toggledAssets={[h.s]:!1,[c.U]:!1,[u.re]:!1,[p.Mp]:!1,[m.Nj]:!1,[g.s]:!1},this.settingsToggler=new v.u(this.settingsData,this.toggledAssets)}async activate(){if(!this.initialized){this.initialized=!0;const{market:e}=this.engine,[t,s,r,n,h]=await Promise.all([e.waitForData(o.f),e.waitForData(a.H),e.waitForData(d.c),e.waitForData(l.D),e.waitForData(i.O)]),c=new f.Q(t.blurs);c.sort(((e,t)=>e.index-t.index)),c.priority=f.K.LOW,this.dataMap={blurData:t,blurEditorData:s,blurList:c,floorsViewData:r,settings:this.settingsData,sweepViewData:n,viewmodeData:h}}this.settingsToggler.toggle(!0),this.toggleBlurTool(n.t.IDLE)}async deactivate(){this.settingsToggler.toggle(!1),this.toggleBlurTool(n.t.OFF)}async toggleBlurTool(e){this.engine.commandBinder.issueCommand(new r.AQ(e))}}},94547:(e,t,s)=>{"use strict";s.d(t,{U:()=>M});var i=s(85893),r=s(67294),n=s(53721),a=s(94184),o=s.n(a),l=s(25813),d=s(2116),h=s(36114),c=s(47210),u=s(67467),m=s(19674),g=s(94329),p=s(53485);class ActionBar extends r.Component{addChildClasses(e){return!!e&&(0,r.cloneElement)(e,{className:`action-bar-item ${e.props.className||""}`})}render(){const{children:e}=this.props;return(0,i.jsx)("div",Object.assign({className:"action-bar"},{children:r.Children.map(e,this.addChildClasses)}),void 0)}}var v,f=s(60771);!function(e){e.size="size",e.scale="scale",e.feather="feather",e.pressure="pressure",e.opacity="opacity",e.state="state"}(v||(v={}));var b=s(41421),S=s(81960),C=s(14576),T=s(13789),w=function(e,t,s,i){var r,n=arguments.length,a=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,s,a):r(t,s))||a);return n>3&&a&&Object.defineProperty(t,s,a),a};const{BLURS:B}=T.Z.WORKSHOP,E=(0,n.u7)(n.ZP);var y;!function(e){e.CREATE="create",e.BRUSH_SIZE="brushsize"}(y||(y={}));let M=class BlurToolOverlay extends r.Component{constructor(e){super(e),this.bindings=[],this.onToolStateChange=e=>{let{creating:t}=this.state;e===C.t.IDLE?t=!1:e===C.t.PAINTING&&(t=!0),this.setState({toolState:e,creating:t})},this.onBrushStateChange=e=>{this.setState({brushState:e})},this.onSelectedBlurChange=e=>{this.setState({selectedBlur:e})},this.onBrushSizeChange=e=>{const t=Math.round((0,m.et)(e,0,1,1,100));this.setState({brushSize:t})},this.onBrushSizeSliderChange=e=>{const{commandBinder:t}=this.context;this.dismissTooltip(y.BRUSH_SIZE);const s=(0,m.et)(e,1,100,0,1);t.issueCommand(new S.d8(s))},this.onDeleteClick=async()=>{const{toolState:e}=this.state;await this.deleteSelectedBlur(),e===C.t.PAINTING&&this.context.commandBinder.issueCommand(new S.AQ(C.t.IDLE))},this.onCreateClick=()=>{this.dismissTooltip(y.CREATE);let e=C.t.IDLE;this.state.toolState===C.t.IDLE&&(e=C.t.PAINTING),this.context.commandBinder.issueCommand(new S.AQ(e))},this.dismissTooltip=e=>{const t=Object.assign({},this.state.showTooltips);t[e]=!1,this.setState({showTooltips:t})};const{viewmodeData:t}=this.props.manager.dataMap;this.state={toolState:C.t.IDLE,brushState:b.e.DISABLED,viewmode:t.currentMode,brushSize:20,selectedBlur:null,showHints:!0,creating:!1,showTooltips:{[y.CREATE]:!0,[y.BRUSH_SIZE]:!0}}}componentDidMount(){const{blurEditorData:e,viewmodeData:t}=this.props.manager.dataMap;this.bindings.push(e.onPropertyChanged("toolState",this.onToolStateChange),e.onSelectedBlurChanged(this.onSelectedBlurChange),e.brush.onPropertyChanged(v.scale,this.onBrushSizeChange),e.brush.onPropertyChanged(v.state,this.onBrushStateChange),e.interactions.onPropertyChanged("createdBlur",(()=>{this.setState({showHints:!1})})),t.makeModeChangeSubscription((e=>{this.setState({viewmode:e})}))),this.onBrushSizeChange(e.brush.scale)}componentWillUnmount(){for(const e of this.bindings)e.cancel();this.bindings=[]}deleteSelectedBlur(){const{selectedBlur:e}=this.state,{commandBinder:t}=this.context;if(!e)throw new Error("Cannot delete, no Blur selected");t.issueCommand(new u.TL(e.id))}renderBrushControls(){const{brushSize:e,toolState:t}=this.state;return t!==C.t.PAINTING?null:(0,i.jsxs)("div",Object.assign({className:"brush-controls"},{children:[this.renderBrushSizeTooltip(),(0,i.jsx)("div",Object.assign({className:"brush-size-control"},{children:(0,i.jsx)(E,{min:1,max:100,step:1,included:!0,dots:!1,value:e,onChange:this.onBrushSizeSliderChange},void 0)}),void 0)]}),void 0)}renderOverlayMessage(){const{locale:e}=this.context,{toolState:t,showHints:s}=this.state;if(!s||t!==C.t.PAINTING)return null;const r=e.t((0,f.Jm)()?B.OVERLAY_MESSAGE_TOUCH:B.OVERLAY_MESSAGE);return(0,i.jsxs)("div",Object.assign({className:"overlay-message"},{children:[(0,i.jsx)("div",{className:"icon icon-brush-outline"},void 0),(0,i.jsx)("span",Object.assign({className:"message"},{children:r}),void 0)]}),void 0)}renderCreateTooltip(){const{showTooltips:e}=this.state;if(!e[y.CREATE])return null;const t=this.context.locale.t(B.CREATE_TOOLTIP_TITLE),s=this.context.locale.t(B.CREATE_TOOLTIP_MESSAGE);return(0,i.jsx)(p.u,{className:"tooltip-simple-medium",open:!0,closeButton:!0,title:t,onClose:()=>this.dismissTooltip(y.CREATE),message:(0,i.jsx)("div",Object.assign({className:"message"},{children:s}),void 0),arrowPos:p.x.BOTTOM_CENTER},void 0)}renderBrushSizeTooltip(){const{showTooltips:e}=this.state;if(!e[y.BRUSH_SIZE])return null;const t=this.context.locale.t(B.BRUSH_TOOLTIP_TITLE),s=this.context.locale.t(B.BRUSH_TOOLTIP_MESSAGE);return(0,i.jsx)(p.u,{className:"tooltip-simple-medium",open:!0,closeButton:!0,title:t,onClose:()=>this.dismissTooltip(y.BRUSH_SIZE),message:(0,i.jsx)("div",Object.assign({className:"message"},{children:s}),void 0),arrowPos:p.x.BOTTOM_CENTER},void 0)}render(){const{brushState:e,toolState:t,selectedBlur:s,viewmode:r}=this.state,n=t===C.t.PAINTING&&s?"icon-checkmark":"icon-plus",a=c.BN.ENABLED,l=r===g.Ey.Panorama?c.BN.ENABLED:c.BN.DISABLED,d=o()("overlay-cta-btn",{"overlay-cta-cancel":t===C.t.PAINTING&&!s}),u=o()("overlay blur-tool-overlay",{painting:e===b.e.PAINTING});return t===C.t.SUGGESTING?null:(0,i.jsxs)("div",Object.assign({className:u},{children:[this.renderOverlayMessage(),(0,i.jsxs)(ActionBar,{children:[(0,i.jsxs)("div",Object.assign({className:"overlay-cta"},{children:[this.renderCreateTooltip(),(0,i.jsx)(h.hU,{className:d,iconClass:n,buttonStyle:h.Dd.PRIMARY,buttonState:l,onClick:this.onCreateClick},void 0),s&&s.editable&&(0,i.jsx)(h.hU,{className:"overlay-cta-button-outer",buttonStyle:h.Dd.OVERLAY,iconClass:"icon-delete",buttonState:a,onClick:this.onDeleteClick},void 0)]}),void 0),this.renderBrushControls()]},void 0)]}),void 0)}};M.contextType=l.I,M=w([d.Z],M)},83714:(e,t,s)=>{"use strict";s.d(t,{I:()=>P});var i=s(85893),r=s(67294),n=s(17490),a=s(67467),o=s(81960),l=s(19520),d=s(57474),h=s(15425),c=s(39428),u=s(84376),m=s(79394),g=s(14576),p=s(31886),v=s(21302),f=s(94184),b=s.n(f),S=s(79553),C=s(92532),T=s(347),w=s(96005),B=s(6989),E=s(13646),y=s(67196),M=s(13789),I=s(25813);const{BLURS:j}=M.Z.WORKSHOP;class BlurListItem extends r.Component{constructor(e){super(e),this.bindings=[],this.onBlurChanged=()=>{const e=this.getBlur();this.setState({status:e.status,visible:e.visible,editable:e.editable,index:e.index})},this.onSelectedChanged=()=>{const{selected:e}=this.getBlurState();this.setState({selected:e})},this.selectItem=()=>{const{commandBinder:e}=this.context,{toolPanelLayout:t}=this.context.toolsData,s=this.getBlur();e.issueCommand(new o.mP(s)),e.issueCommand(new o.AQ(g.t.IDLE)),t===S.wS.BOTTOM_PANEL&&e.issueCommand(new C.zK(!0))},this.deleteItem=()=>{this.context.commandBinder.issueCommand(new a.TL(this.props.sid))},this.toggleVisibility=e=>{e.stopPropagation(),this.context.commandBinder.issueCommand(new o.AB(this.props.sid))};const t=this.getBlur(),s=this.getBlurState();this.state={selected:s.selected,status:t.status,visible:t.visible,editable:t.editable,index:t.index}}componentDidMount(){this.createSubscriptions()}componentDidUpdate(e){e.sid!==this.props.sid&&(this.cancelSubscriptions(),this.createSubscriptions())}componentWillUnmount(){this.cancelSubscriptions()}createSubscriptions(){const e=this.getBlur(),t=this.getBlurState();this.bindings=[e.onChanged(this.onBlurChanged),t.onPropertyChanged("selected",this.onSelectedChanged)];const s={selected:t.selected,status:e.status,visible:e.visible,editable:e.editable,index:e.index};this.setState(s)}cancelSubscriptions(){for(const e of this.bindings)e.cancel()}getBlur(){return this.props.manager.dataMap.blurData.get(this.props.sid)}getBlurState(){return this.props.manager.dataMap.blurEditorData.getState(this.props.sid)}blurStatusToPhraseKey(e){switch(e){case B.Q.PROCESSING:return j.BLUR_STATUS_PROCESSING;case B.Q.APPLIED:return j.BLUR_STATUS_APPLIED;case B.Q.FAILED:return j.BLUR_STATUS_FAILED;case B.Q.PENDING:default:return}}render(){const{locale:e}=this.context,{sid:t,selectMode:s,selectedItems:r,onSelectItem:n,onCheckboxClick:a}=this.props,{visible:o,editable:l,selected:d,status:h,index:c}=this.state,u=l?n:void 0,m=b()({"accordion-item-with-options":l,"accordion-item-with-toggle":l,"accordion-item-without-toggle":!s}),g=e.t(j.DEFAULT_BLUR_NAME,{number:c}),p=this.blurStatusToPhraseKey(h),v=p?e.t(p):"";return(0,i.jsxs)(T.Q,Object.assign({sid:t,enabled:o,selected:d,className:m,onSelect:s?u:this.selectItem},{children:[!s&&(0,i.jsx)(E.Z,{id:t,visible:o,showTooltip:j.SHOW_LIST_ITEM_TOOLTIP_MESSAGE,hideTooltip:j.HIDE_LIST_ITEM_TOOLTIP_MESSAGE,forceDisable:!l,onClick:this.toggleVisibility},void 0),s&&(0,i.jsx)("div",Object.assign({className:"accordion-checkbox"},{children:(0,i.jsx)(y.X,{enabled:l,checked:r&&r.has(t),id:t,onChange:a,stopPropagation:!0,dataValue:t},void 0)}),void 0),(0,i.jsxs)("span",Object.assign({className:"accordion-item-text"},{children:[g,v&&(0,i.jsx)("span",Object.assign({className:"accordion-item-status"},{children:v}),void 0)]}),void 0),l&&!s&&(0,i.jsx)(w.e,{id:t,menu:[[j.DELETE_BLUR_CTA,this.deleteItem]]},void 0)]}),t)}}BlurListItem.contextType=I.I;const{BLURS:x}=M.Z.WORKSHOP;class BlurListGroupComponent extends r.Component{constructor(e){super(e),this.bindings=[],this.onFloorChange=()=>{const{currentFloor:e}=this.props.manager.dataMap.floorsViewData;this.state.isCurrentFloor&&e&&e.id!==this.props.group.id&&this.setState({isCurrentFloor:!1}),!this.state.isCurrentFloor&&e&&e.id===this.props.group.id&&this.setState({isCurrentFloor:!0})};const{currentFloor:t}=this.props.manager.dataMap.floorsViewData;this.state={isCurrentFloor:!!t&&t.id===this.props.group.id,sortedItems:BlurListGroupComponent.sortItems(this.props.group.items)}}componentDidMount(){const{floorsViewData:e}=this.props.manager.dataMap;this.bindings.push(e.makeFloorChangeSubscription(this.onFloorChange))}componentWillUnmount(){for(const e of this.bindings)e.cancel()}static sortItems(e){return e.sort(((e,t)=>e.index-t.index))}render(){const{locale:e}=this.context,{isCurrentFloor:t}=this.state,{group:s,manager:r,multiFloor:n}=this.props,a=!n||t,o=e.t(n?x.MULTI_FLOOR_EMPTY_MESSAGE:x.SINGLE_FLOOR_EMPTY_MESSAGE),l=(0,i.jsx)(v.K,{group:s,multiFloor:n,selectMode:this.props.selectMode,onSelectGroup:this.props.onSelectGroup,isGroupSelected:this.props.isGroupSelected},void 0);return(0,i.jsx)(p.b,Object.assign({id:s.id,open:a,emptyMessage:o,header:l,collapsible:!0,onExpandChange:this.props.onExpandChange},{children:s.items.map((e=>(0,i.jsx)(BlurListItem,{manager:r,sid:e.id,selectMode:this.props.selectMode,selectedItems:this.props.selectedItems,onCheckboxClick:this.props.onCheckboxClick,onSelectItem:this.props.onSelectItem},e.id)))}),void 0)}}BlurListGroupComponent.contextType=I.I;const{BLURS:D}=M.Z.WORKSHOP,R="other";class BlursList extends r.Component{constructor(e){super(e),this.onBlursChanged=()=>{const{blurList:e}=this.props.manager.dataMap;e.length!==this.state.numberOfBlurs&&this.updateList()},this.onBlurProcessingChange=()=>{const{selectMode:e,toggleSelectMode:t}=this.props,{blurData:s}=this.props.manager.dataMap,i=s.hasProcessingBlurs();i&&e&&t(),this.setState({blursApplying:i})},this.onBlurToolStateChange=()=>{const{selectMode:e,toggleSelectMode:t}=this.props,{toolState:s}=this.props.manager.dataMap.blurEditorData;s!==g.t.IDLE&&e&&t(),this.setState({toolState:s})},this.batchDelete=async()=>{const{selectedItems:e,clearSelected:t}=this.props,{blurData:s}=this.props.manager.dataMap;for(const t of e){if(!s.get(t).editable)return this.alert(D.ALREADY_PROCESSING_ALERT_MESSAGE,D.ALREADY_PROCESSING_ALERT_TITLE),!1}return this.context.commandBinder.issueCommand(new a.TL(...e)),t(),!0},this.batchToggleVisibility=async()=>{const{selectedItems:e}=this.props;return this.context.commandBinder.issueCommand(new o.$6(Array.from(e))),!0},this.selectAll=()=>{this.props.onSelectAll(this.state.groups)},this.state={groups:{},renamingItem:null,blursApplying:this.props.manager.dataMap.blurData.hasProcessingBlurs(),toolState:this.props.manager.dataMap.blurEditorData.toolState,numberOfBlurs:this.props.manager.dataMap.blurList.length}}componentDidMount(){const{blurList:e,blurData:t,blurEditorData:s}=this.props.manager.dataMap;this.bindings=new n.V(e.onChanged(this.onBlursChanged),t.makeProcessingSubscription(this.onBlurProcessingChange),s.onPropertyChanged("toolState",this.onBlurToolStateChange)),this.onBlurProcessingChange(),this.updateList()}componentWillUnmount(){this.bindings.cancel()}updateList(){const{locale:e}=this.context,{blurList:t,floorsViewData:s}=this.props.manager.dataMap,i={},r=t.groupBy("floorId");s.floors.iterate((e=>{i[e.id]={id:e.id,name:e.name,items:r[e.id]||[]}})),r.null&&(i.other={id:R,name:e.t(D.OTHER_GROUP_LABEL),items:r.null}),this.setState({groups:i,numberOfBlurs:t.length})}alert(e,t=D.DEFAULT_ALERT_TITLE,s=D.DEFAULT_ALERT_CONFIRMATION){const{commandBinder:i}=this.context;i.issueCommand(new m.Q(m.f.DISPLAY,{title:t,message:e,cancellable:!0,confirmPhraseKey:s}))}getListTitle(){const{locale:e}=this.context,{numberOfBlurs:t}=this.state;return e.t(D.NUM_TYPE,t)}renderListTitle(){return(0,i.jsx)("div",Object.assign({className:"list-panel-title"},{children:this.getListTitle()}),void 0)}renderSelectorHeader(){const{batchSelectEnabled:e,selectMode:t,selectedItems:s,toggleSelectMode:r}=this.props,{blursApplying:n,toolState:a}=this.state,o=(null==s?void 0:s.size)>0,l=a!==g.t.IDLE||n;return(0,i.jsx)(d.y,{selectMode:!!t,selectAllCallback:this.selectAll,selectButtonCallback:r,disableToggle:l,hasSelectedItems:o,batchSupported:e},void 0)}renderSelectorFooter(){const{batchSelectEnabled:e,selectMode:t,selectedItems:s}=this.props;if(!e)return null;const{blursApplying:r,toolState:n}=this.state,a=(null==s?void 0:s.size)>0&&n===g.t.IDLE&&!r;return(0,i.jsx)(u.n,{active:!!t,enabled:a,leftButtonCallback:this.batchDelete,rightButtonCallback:this.batchToggleVisibility},void 0)}renderSelectorContent(){const{selectMode:e,selectedItems:t,isGroupBatchSelected:s}=this.props,{groups:r}=this.state,n=Object.keys(r).length>1;return(0,i.jsx)(h.t,Object.assign({selectMode:e},{children:Object.values(r).map((r=>(0,i.jsx)(BlurListGroupComponent,{group:r,multiFloor:n,selectMode:e,selectedItems:t,manager:this.props.manager,onCheckboxClick:this.props.onCheckboxClick,onExpandChange:this.props.onExpandChange,onSelectGroup:this.props.onSelectGroup,onSelectItem:this.props.onSelectItem,isGroupSelected:s(r)},r.id)))}),void 0)}render(){const{toolPanelLayout:e}=this.context.toolsData,t=this.renderSelectorHeader(),s=this.renderSelectorFooter(),r=this.renderSelectorContent();return(0,i.jsx)(l.L,Object.assign({active:!0,toolPanelLayout:e,title:this.renderListTitle(),subheader:t,footer:s||void 0},{children:(0,i.jsx)("div",Object.assign({className:"list-contents"},{children:r}),void 0)}),void 0)}}BlursList.contextType=I.I;const P=(0,c.A)(BlursList,(e=>e.editable))},51805:(e,t,s)=>{"use strict";s.d(t,{s:()=>i,x:()=>r});const i="photo-grid-visible",r="features/batch-select"},48653:(e,t,s)=>{"use strict";s.d(t,{e:()=>LineBox});var i=s(2212),r=s(12216),n=s(74693);if(984==s.j)var a=s(59134);if(984==s.j)var o=s(34658);if(984==s.j)var l=s(28900);var d=s(2210);const h=[new i.Vector3(-1,-1,-1),new i.Vector3(-1,-1,1),new i.Vector3(-1,-1,1),new i.Vector3(-1,1,1),new i.Vector3(-1,1,1),new i.Vector3(-1,1,-1)].map((e=>e.multiplyScalar(.5)));function c(e){return t=>t.clone().applyAxisAngle(r.f.UP,e)}function u(e,t){return e.push(t.x,t.y,t.z),e}const m=[h,h.map(c(Math.PI/2)),h.map(c(Math.PI)),h.map(c(Math.PI/-2))].map((e=>e.reduce(u,[]))),g=new n.Y({color:d.ix,linewidth:d.b5,side:i.DoubleSide}),p=new i.Color(d.Q6),v=new i.Color(d.ix);class LineBox extends(984==s.j?i.Group:null){constructor(){super(),this.material=g.clone(),this.updateResolution=()=>{const e=document.getElementById("#canvas-container");let t=(0,l.bV)(),s=(0,l.NS)();e&&(s=e.offsetWidth,t=e.offsetHeight),this.material.resolution.set(s,t)},m.forEach((e=>{const t=(new a.z).setPositions(e),s=new o.x(t,this.material);this.add(s)})),window.addEventListener("resize",this.updateResolution),this.updateResolution()}dispose(){window.removeEventListener("resize",this.updateResolution)}setEnabled(e){this.material.setOpacity(e?1:.5)}setSelected(e){this.material.color=e?p:v}}},21918:(e,t,s)=>{"use strict";if(s.d(t,{_:()=>MeshTrimCollider}),984==s.j)var i=s(2212);class MeshTrimCollider extends(984==s.j?i.Mesh:null){constructor(){super(...arguments),this.raycastEnabled=!0}}},26603:(e,t,s)=>{"use strict";if(s.d(t,{jC:()=>ChangeMeshTrimViewCommand,mf:()=>SelectMeshTrimCommand,wI:()=>UnselectMeshTrimCommand,U_:()=>ActivateMeshTrimEditorCommand,zP:()=>DeactivateMeshTrimEditorCommand,rG:()=>DeleteMeshTrimViewCommand,US:()=>CreateMeshTrimViewCommand,mb:()=>MoveMeshTrimViewToAllFloorsCommand,zR:()=>RecenterMeshTrimEditorCommand,YM:()=>EditMeshTrimCommand,Xj:()=>ChangeMeshTrimTransformControlsModeCommand}),984==s.j)var i=s(17386);class ChangeMeshTrimViewCommand extends(984==s.j?i.m:null){constructor(e){super(),this.payload=e,this.id="CHANGE_MESH_TRIM_EDITOR_VIEW"}}class SelectMeshTrimCommand extends(984==s.j?i.m:null){constructor(e){super(),this.payload=e,this.id="SELECT_MESH_TRIM"}}class UnselectMeshTrimCommand extends(984==s.j?i.m:null){constructor(){super(),this.id="UNSELECT_MESH_TRIM"}}class ActivateMeshTrimEditorCommand extends(984==s.j?i.m:null){constructor(){super(...arguments),this.id="ACTIVATE_MESH_TRIM_EDITOR"}}class DeactivateMeshTrimEditorCommand extends(984==s.j?i.m:null){constructor(){super(...arguments),this.id="DEACTIVATE_MESH_TRIM_EDITOR"}}class DeleteMeshTrimViewCommand extends(984==s.j?i.m:null){constructor(e){super(),this.payload=e,this.id="DELETE_MESH_TRIM"}}class CreateMeshTrimViewCommand extends(984==s.j?i.m:null){constructor(){super(),this.id="CREATE_MESH_TRIM"}}class MoveMeshTrimViewToAllFloorsCommand extends(984==s.j?i.m:null){constructor(e){super(),this.payload=e,this.id="CHANGE_TRIM_MESH_GROUP"}}class RecenterMeshTrimEditorCommand extends(984==s.j?i.m:null){constructor(){super(),this.id="RECENTER_MESH_TRIM_EDITOR"}}class EditMeshTrimCommand extends(984==s.j?i.m:null){constructor(){super(),this.id="EDIT_MESH_TRIM"}}class ChangeMeshTrimTransformControlsModeCommand extends(984==s.j?i.m:null){constructor(e){super(),this.payload=e,this.id="SWITCH_MESH_TRIM_EDITOR_MODE"}}},40291:(e,t,s)=>{"use strict";s.d(t,{t:()=>MeshTrimEditorModule});var i=s(2212),r=s(24764),n=s(48715),a=s(53694),o=s(47724),l=s(36297),d=s(3805),h=s(2725),c=s(88216),u=s(81507),m=s(35003),g=s(51869),p=s(94610),v=s(88727),f=s(27326),b=s(31278),S=s(76863),C=s(56247),T=s(67027),w=s(25269),B=s(23847),E=s(33512),y=s(96909),M=s(59088),I=s(35597),j=s(21479),x=s(12216),D=s(65989),R=s(60697),P=s(76870);class DragController{constructor(e,t){this.onDragBegin=(e,t,s,r)=>!(void 0===r||!r.face)&&(!!t.meshTrim&&(this.currentDragEvent={dragStartPosition:new i.Vector2(e.position.x,e.position.y),meshTrimStartPosition:t.meshTrim.position.clone(),meshTrimStartScale:t.meshTrim.scale.clone(),worldChange:new i.Vector3(0,0,0),dragNormal:r.face.normal,buttons:e.buttons,bounds:s},t.onDragBegin(this.currentDragEvent))),this.onDrag=(e,t,s)=>{if(void 0===this.currentDragEvent)return!1;const{buttons:i,dragStartPosition:r}=this.currentDragEvent;return i===P.r3.PRIMARY&&(this.currentDragEvent.worldChange=this.getWorldChange(r,e.position),t.onDrag(this.currentDragEvent))},this.onDragEnd=(e,t,s)=>{if(void 0===this.currentDragEvent)return!1;this.currentDragEvent.dragEndPosition=new i.Vector2(e.position.x,e.position.y);const r=this.onDrag(e,t,s);return this.currentDragEvent=void 0,r},this.cameraData=e,this.renderer=t}getWorldChange(e,t){const s=this.cameraData.pose.rotation,r=this.renderer.getCamera(),n=new i.Vector3(t.x,t.y,-1).unproject(r),a=new i.Vector3(e.x,e.y,-1).unproject(r),o=n.sub(a),l=x.f.BACK.clone().applyQuaternion(s);return o.projectOnPlane(l),o}}var O=s(63970),A=s(39797),_=s(72923);class MeshTrimColliderComparator{constructor(){}compare(e){return e instanceof _.d?e.raycastEnabled:e instanceof O.m}}function L(e){return Math.round(100*e)/100}var k=s(38032),N=s(72863),G=s(28900),V=s(26603),U=s(48358);function F(e,t){const s=t.clone(),r=s.getSize(new i.Vector3);e.scale.clamp(new i.Vector3,r),s.expandByVector(e.scale.clone().multiplyScalar(-.5)),s.clampPoint(e.position,e.position)}var z=s(2210),H=s(92078),Q=s(89046),W=s(49080),Z=s(79553),$=s(24151);class MeshTrimEditorModule extends o.Y{constructor(){super(...arguments),this.name="mesh_trim",this.activeObservable=new n.f(!1),this.meshTrimViewsById={},this.floorGroups={},this.permanentBindings=[],this.commandBindings=[],this.currentMeshTrimViewObservable=new n.f(null),this.viewStateObservable=new n.f(k.Um.PERSPECTIVE),this.stateObservable=new n.f(A.e.IDLE),this.setCameraPosePromise=Promise.resolve(),this.activateEditor=async()=>{const e=new MeshTrimColliderComparator,t=this.toolsData.toolPanelLayout===Z.wS.NARROW||this.toolsData.toolPanelLayout===Z.wS.BOTTOM_PANEL,s=0===this.bindings.length;s&&t&&this.engine.commandBinder.issueCommand(new Q.Bz(W.P.TRIM_SMALL_SCREEN_WARNING,!0)),s?(this.dragController=new DragController(this.cameraData,this.renderer),this.bindings.push(this.inputModule.registerMeshHandler(m.R,r.s.isInstanceOf(O.m),this.onMeshTrimClicked),this.inputModule.registerMeshHandler(m.R,r.s.is(S.Pv),this.onModelClicked),this.inputModule.registerMeshHandler(m.R,r.s.isType(w.i),this.onBackgroundClicked),this.inputModule.registerMeshHandler(g.E0,e,this.onDragBegin),this.inputModule.registerMeshHandler(g._t,e,this.onDrag),this.inputModule.registerMeshHandler(g._R,e,this.onDragEnd),this.inputModule.registerMeshHandler(g._t,r.s.is(S.Pv),this.onTransformControlsCheck),this.inputModule.registerMeshHandler(g._t,r.s.isType(w.i),this.onTransformControlsCheck),this.inputModule.registerMeshHandler(p.z,e,this.onHover),this.inputModule.registerMeshHandler(p.A,e,this.onUnhover),this.inputModule.registerHandler(v.e,this.onKey),this.floorsViewData.makeFloorChangeSubscription(this.onFloorChanged))):this.renewSubscriptions(this.bindings),this.commandBindings.length?this.renewSubscriptions(this.commandBindings):this.commandBindings.push(this.engine.commandBinder.addBinding(V.mf,this.selectMeshTrimCommand),this.engine.commandBinder.addBinding(V.YM,this.editMeshTrimCommand),this.engine.commandBinder.addBinding(V.wI,this.unselectMeshTrimCommand),this.engine.commandBinder.addBinding(V.US,this.onCreateMeshTrimCommand),this.engine.commandBinder.addBinding(V.rG,this.onDeleteMeshTrimCommand),this.engine.commandBinder.addBinding(V.zR,this.recenterCamera),this.engine.commandBinder.addBinding(V.jC,this.changeViewState),this.engine.commandBinder.addBinding(V.mb,this.onMoveMeshTrimToAllFloors),this.engine.commandBinder.addBinding(V.Xj,this.changeTransformControlsMode)),this.setViewsVisible(!0),await this.activateViewmode(),this.active=!0},this.deactivateEditor=async()=>{this.active&&(this.active=!1,this.cancelSubscriptions(this.bindings),this.cancelSubscriptions(this.commandBindings),this.setViewsVisible(!1),await this.resetCameraPose())},this.selectMeshTrimCommand=async({meshTrimId:e})=>{this.onMeshTrimSelected(e)},this.unselectMeshTrimCommand=async()=>{this.onMeshTrimUnselected()},this.editMeshTrimCommand=async()=>{if(!this.currentMeshTrimView)return;const[e,t]=this.getNearestPose();await this.setCameraPose(e,t)},this.onTransformControlsCheck=()=>this.transformControls.dragging,this.onDragBegin=(e,t,s)=>!!this.transformControls.dragging||this.dragController.onDragBegin(e,t,this.getTrimBounds(),s),this.onDrag=(e,t,s)=>!!this.transformControls.dragging||this.dragController.onDrag(e,t,s),this.onDragEnd=(e,t,s)=>!!this.transformControls.dragging||this.dragController.onDragEnd(e,t,s),this.onFloorChanged=()=>{var e;const t=this.floorsViewData.currentFloorMeshGroup;for(const e in this.floorGroups){const s=`${t}`===e;this.floorGroups[e].visible=s}(null===(e=this.currentMeshTrimView)||void 0===e?void 0:e.meshTrim.meshGroup)!==t&&this.onMeshTrimUnselected()},this.onHover=(e,t)=>{t.onHover()},this.onUnhover=(e,t)=>{t.onUnhover()},this.onModelClicked=(e,t)=>{const s=this.floorsViewData.floors.getFloorByMeshGroup(t.meshGroup);return!(!s||!this.currentMeshTrimView)&&(s.meshGroup===this.currentMeshTrimView.meshTrim.meshGroup&&this.onMeshTrimUnselected(),!1)},this.onMeshTrimClicked=(e,t,s)=>{void 0!==s&&s.face&&t.onClick()},this.onBackgroundClicked=e=>(this.onMeshTrimUnselected(),!1),this.onMeshTrimSelected=async e=>{const t=this.meshTrimViewsById[e];if(!t)return;const s=this.floorsViewData.getFloorIndexForMeshGroup(t.meshTrim.meshGroup),i=new h.h9(s);await this.engine.commandBinder.issueCommand(i),this.currentMeshTrimView=t,this.state=A.e.EDITING,this.transformControls.attachToTrim(t,this.getTrimBounds())},this.onMeshTrimUnselected=()=>{this.currentMeshTrimView=null,this.state=A.e.IDLE,this.transformControls.detach()},this.onCreateMeshTrimCommand=async()=>{const e=this.viewState,t=this.floorsViewData.currentFloorMeshGroup,s=this.data.getTrimsForMeshGroup(t).length+1,i=s===C.t,r=this.createMeshTrim();this.engine.commandBinder.issueCommand(new D.A(r)),this.addTrimView(r),await this.onMeshTrimSelected(r.id),this.state=A.e.CREATING,this.createStateSubscription=r.onChanged((()=>this.state=A.e.EDITING)),this.analytics.track("trim_created",{trim_id:r.id,view_state:e,trim_count_for_floor:s,is_at_floor_limit:i})},this.onDeleteMeshTrimCommand=async({meshTrimId:e})=>this.deleteMeshTrim(e),this.onMoveMeshTrimToAllFloors=async e=>{this.engine.commandBinder.issueCommand(new D.dg(e));const t=this.meshTrimViewsById[e.id];this.getFloorGroup(R.e).add(t)},this.changeViewState=async({viewChange:e})=>{try{const t=this.getCameraBounds(),s=this.getCameraTarget(),i=this.cameraData.pose,r=this.viewState,[n,a]=(0,k.zx)(r,e,t,s,i);return this.setCameraPosePromise=this.setCameraPose(n,a),this.setCameraPosePromise}catch(e){this.log.debug(e)}},this.recenterCamera=async()=>{if(!this.currentMeshTrimView)return;const[e,t]=this.getNearestPose();this.setCameraPosePromise=this.setCameraPose(e,t)},this.deleteTrimView=e=>{e.dispose();const t=this.floorGroups[e.meshTrim.meshGroup];t&&t.remove(e),this.inputModule.unregisterMesh(e),this.inputModule.unregisterMesh(e.backMesh),delete this.meshTrimViewsById[e.meshTrim.id]},this.onKey=e=>{if(e.state!==c.M.DOWN)return;const t=MeshTrimEditorModule.KeysToDirection[e.key];if(t)return this.moveMeshTrim(t.clone());switch(e.key){case u.R.ESCAPE:this.isCreating()?this.deleteCurrentMeshTrim():this.isEditing()&&this.onMeshTrimUnselected();break;case u.R.BACKSPACE:case u.R.DELETE:this.deleteCurrentMeshTrim();break;case u.R.TWO:this.engine.commandBinder.issueCommand(new V.jC({viewChange:k.cY.PERSPECTIVE}));break;case u.R.THREE:this.engine.commandBinder.issueCommand(new V.jC({viewChange:k.cY.TOP}));break;case u.R.FOUR:this.transformControls.setMode(H.g.Translate);break;case u.R.FIVE:this.transformControls.setMode(H.g.Scale);break;case u.R.SIX:this.transformControls.setMode(H.g.Rotate)}},this.changeTransformControlsMode=async({mode:e})=>{this.transformControls.setMode(e)}}async init(e={},t){this.engine=t,this.floorsViewData=await this.engine.market.waitForData(f.c),this.renderer=await this.engine.getModuleBySymbol(y.y.WEBGL_RENDERER),this.inputModule=await this.engine.getModuleBySymbol(y.y.INPUT),this.data=await this.engine.market.waitForData(E.Z),this.cameraData=await this.engine.market.waitForData(M.M_),this.viewmodeData=await this.engine.market.waitForData(I.O),this.applicationData=await this.engine.market.waitForData(j.pu),this.meshData=await this.engine.market.waitForData(T._),this.analytics=await this.engine.getModule(B.default),this.toolsData=await this.engine.market.waitForData($.t),this.rootGroup=new i.Group,this.rootGroup.renderOrder=U.z.meshTrims,this.rootGroup.name="Mesh Trims",this.setViewsVisible(!1),this.renderer.getScene().add(this.rootGroup);const s=this.floorsViewData.floors.getOrderedValues().map((e=>e.meshGroup));s.push(R.e);for(const e of s){const t=this.data.getTrimsForMeshGroup(e);if(t)for(const e of t)this.addTrimView(e)}this.transformControls=new H.x(this.rootGroup,this.renderer.getCamera(),this.renderer.threeRenderer.domElement,this.cameraData),this.permanentBindings.push(this.engine.commandBinder.addBinding(V.U_,this.activateEditor),this.engine.commandBinder.addBinding(V.zP,this.deactivateEditor))}dispose(e){super.dispose(e),this.deactivateEditor(),this.forEachMeshTrimView(this.deleteTrimView),this.cancelSubscriptions(this.permanentBindings)}onUpdate(e){this.transformControls.update()}async activateViewmode(){return this.applicationData.phase===j.nh.PLAYING?this.transitionViewmode():new Promise((e=>{const t=this.applicationData.onPropertyChanged("phase",(async s=>{s===j.nh.PLAYING&&(t.cancel(),await this.transitionViewmode(),e())}))}))}async transitionViewmode(){await this.engine.commandBinder.issueCommand(new d._i(d.BD.DOLLHOUSE)),this.active&&await this.engine.commandBinder.issueCommand(new l.M)}forEachMeshTrimView(e){for(const t in this.meshTrimViewsById)e(this.meshTrimViewsById[t])}get currentMeshTrimView(){return this.currentMeshTrimViewObservable.value}set currentMeshTrimView(e){this.currentMeshTrimViewObservable.value&&(this.currentMeshTrimViewObservable.value.selected=!1),this.currentMeshTrimViewObservable.value=e,this.currentMeshTrimViewObservable.value&&(this.currentMeshTrimViewObservable.value.selected=!0)}get viewState(){return this.viewStateObservable.value}set viewState(e){this.viewStateObservable.value=e,e===k.Um.PERSPECTIVE&&this.transformControls.setPerspectiveMode()}get state(){return this.stateObservable.value}set state(e){this.createStateSubscription&&this.createStateSubscription.cancel(),this.stateObservable.value=e}get active(){return this.activeObservable.value}set active(e){this.activeObservable.value=e}cancelSubscriptions(e){e.forEach((e=>e.cancel()))}renewSubscriptions(e){e.forEach((e=>e.renew()))}setViewsVisible(e){this.rootGroup.visible=e}createMeshTrim(){const e=this.floorsViewData.currentFloorMeshGroup,t=this.cameraData.pose,s=new i.Vector3;if(this.viewState===k.Um.PERSPECTIVE){const e=x.f.FORWARD.clone().applyQuaternion(t.rotation);e.setLength(t.focalDistance),s.copy(t.position).add(e)}else s.copy(t.position);const r=z.JB,n=this.viewState===k.Um.PERSPECTIVE?t.focalDistance*r:this.cameraData.zoom(),o=new i.Vector3(1,1,1).multiplyScalar(n),l=new a.r(s,o,(new i.Quaternion).identity(),Number.MAX_SAFE_INTEGER,!0,e);return F(l,this.getTrimBounds()),l}deleteCurrentMeshTrim(){this.currentMeshTrimView&&this.deleteMeshTrim(this.currentMeshTrimView.meshTrim.id)}deleteMeshTrim(e){const t=this.meshTrimViewsById[e];if(!t)return;const s=this.viewState,i=t===this.currentMeshTrimView,r=this.data.getTrimsForMeshGroup(t.meshTrim.meshGroup),n=r.length===C.t,a=r.length-1;i&&this.onMeshTrimUnselected(),this.engine.commandBinder.issueCommand(new D.yg(t.meshTrim)),this.deleteTrimView(t),this.analytics.track("trim_deleted",{trim_id:e,view_state:s,currently_selected:i,trim_count_for_floor:a,was_at_floor_limit:n})}async setCameraPose(e,t){const s=this.viewState===k.Um.PERSPECTIVE;this.viewState=t;const r=t===k.Um.PERSPECTIVE,n=r?d.BD.DOLLHOUSE:d.BD.ORTHOGRAPHIC,a=r?e.rotation:function(e){const t=L(x.f.UP.clone().applyQuaternion(e).y),s=L(x.f.RIGHT.clone().applyQuaternion(e).y),r=L(x.f.LEFT.clone().applyQuaternion(e).y),n=L(x.f.DOWN.clone().applyQuaternion(e).y),a=x.f.BACK.clone(),o=Math.max(t,s,r,n);if(o===t)return e;if(o===s){const t=(new i.Quaternion).setFromAxisAngle(a,Math.PI/-2);return e.multiply(t)}if(o===r){const t=(new i.Quaternion).setFromAxisAngle(a,Math.PI/2);return e.multiply(t)}if(o===n){const t=(new i.Quaternion).setFromAxisAngle(a,Math.PI);return e.multiply(t)}return e}(e.rotation),o=r||s||e.zoom?e.zoom:this.cameraData.orthoZoom();d.mA[n]!==this.viewmodeData.currentMode&&this.engine.commandBinder.issueCommand(new l.I),this.currentMeshTrimViewObservable.value?this.transformControls.attachToTrim(this.currentMeshTrimViewObservable.value,this.getTrimBounds()):this.transformControls.detach();const h=new d._i(n,b.n.Interpolate,{position:e.position,rotation:a,zoom:o});await this.engine.commandBinder.issueCommand(h),this.active&&(this.engine.commandBinder.issueCommand(new l.M),r||this.transformControls.setOrthoMode())}async resetCameraPose(){await this.setCameraPosePromise,this.onMeshTrimUnselected(),this.viewState=k.Um.PERSPECTIVE,await this.engine.commandBinder.issueCommand(new l.I);const e=new d._i(d.BD.DOLLHOUSE,b.n.Interpolate,this.cameraData.pose);await this.engine.commandBinder.issueCommand(e)}addTrimView(e){if(this.meshTrimViewsById[e.id])return this.meshTrimViewsById[e.id];const t=new O.m(e,this.engine.commandBinder);this.engine.addComponent(this,t);return this.getFloorGroup(e.meshGroup).add(t),this.meshTrimViewsById[e.id]=t,this.inputModule.registerMesh(t,!1),this.inputModule.registerMesh(t.backMesh,!1),t}moveMeshTrim(e){if(this.viewState===k.Um.PERSPECTIVE)return;if(!this.currentMeshTrimView)return;const t=this.renderer.getCamera(),s=(0,G.VG)(4,t),i=e.applyQuaternion(this.cameraData.pose.rotation);i.setLength(s);const{meshTrim:r}=this.currentMeshTrimView;r.position.add(i),F(r,this.getTrimBounds()),r.commit()}getFloorGroup(e){let t=this.floorGroups[e];return t||(t=new i.Group,t.name=`${e}`,t.renderOrder=U.z.meshTrims,this.rootGroup.add(t),this.floorGroups[e]=t,t)}getTrimBounds(){var e;return(null===(e=this.floorsViewData.currentFloor)||void 0===e?void 0:e.boundingBox)||this.meshData.bounds}getCameraBounds(){return this.meshData.bounds}getCameraTarget(){const e=new i.Vector3;if(this.currentMeshTrimView)return e.copy(this.currentMeshTrimView.position),e;const t=this.floorsViewData.currentFloor;return t?(t.boundingBox.getCenter(e),e):(this.meshData.bounds.getCenter(e),e)}getNearestPose(){return(0,N.w1)(this.getCameraBounds(),this.getCameraTarget(),this.cameraData.pose)}isCreating(){return this.state===A.e.CREATING}isEditing(){return this.state===A.e.EDITING}}MeshTrimEditorModule.KeysToDirection={[u.R.LEFTARROW]:x.f.LEFT,[u.R.RIGHTARROW]:x.f.RIGHT,[u.R.UPARROW]:x.f.UP,[u.R.DOWNARROW]:x.f.DOWN}},39797:(e,t,s)=>{"use strict";var i;s.d(t,{e:()=>i}),function(e){e.IDLE="IDLE",e.EDITING="EDITING",e.CREATING="CREATING"}(i||(i={}))},72923:(e,t,s)=>{"use strict";s.d(t,{d:()=>MeshTrimHandle});var i=s(2212),r=s(21918),n=s(4901),a=s(12216);var o=s(28900),l=s(2210);const d=new i.MeshBasicMaterial({color:l.Q6});class MeshTrimHandle extends r._{constructor(e,t,s,i,r){super(e,r||d),this.options=t,this.cameraData=s,this.commandBinder=i,this.name="handle"+this.options.name}update(e,t,s){this.meshTrim=e,this.updatePosition(e,t,s),this.updateScale(e,t,s)}getInvertedScale(e,t){const s=t.rotation,r=new i.Quaternion(s.x,s.y,s.z,-s.w);return new i.Vector3(1,1,1).divide(e.scale).applyQuaternion(r)}updatePosition(e,t,s){const i=this.getInvertedScale(e,t),r=this.options.handleDirection.clone().multiplyScalar(.5),n=(function(e,t){const s=a.f.BACK.clone().applyQuaternion(t.rotation),i=e.clone().projectOnVector(s);return t.position.clone().projectOnVector(s).distanceTo(i)}(e.position,t)-this.getRenderDepth(s))*i.z,o=a.f.BACK.clone().applyQuaternion(t.rotation).normalize();o.multiply(o);const l=o.multiplyScalar(n),d=r.applyQuaternion(t.rotation).add(l);this.position.copy(d)}updateScale(e,t,s){const{widthInPixels:r,heightInPixels:n}=this.options,l=this.getInvertedScale(e,t),d=a.f.BACK.clone(),h=new i.Vector3;MeshTrimHandle.ComponentVectors.forEach(((e,t)=>{e.clone().projectOnVector(d).length()>0&&h.setComponent(t,.01*l.getComponent(t));if(e.clone().projectOnVector(a.f.RIGHT).length()>0){if(r){const e=(0,o.VG)(r,s);h.setComponent(t,e*l.getComponent(t))}else h.setComponent(t,1);return}if(e.clone().projectOnVector(a.f.UP).length()>0)if(n){const e=(0,o.VG)(n,s);h.setComponent(t,e*l.getComponent(t))}else h.setComponent(t,1);else;})),h.applyQuaternion(t.rotation),this.scale.copy(h)}getRenderDepth(e){return e.near+.01*(this.options.layer||0)}onHover(){this.commandBinder.issueCommand(new n.u(this.options.cursor))}onUnhover(){this.commandBinder.issueCommand(new n.u(null))}onDragBegin(e){return!0}}MeshTrimHandle.ComponentVectors=[a.f.RIGHT,a.f.UP,a.f.FORWARD]},92078:(e,t,s)=>{"use strict";if(s.d(t,{g:()=>o,x:()=>MeshTrimTransformControls}),984==s.j)var i=s(48715);if(984==s.j)var r=s(27251);if(984==s.j)var n=s(2212);if(984==s.j)var a=s(2210);var o;!function(e){e.Translate="translate",e.Scale="scale",e.Rotate="rotate"}(o||(o={}));class MeshTrimTransformControls{constructor(e,t,s,l){this.camera=t,this.cameraData=l,this.controlModeObservable=new i.f(o.Translate),this.updatePosition=()=>{const e=this.trimView.meshTrim;e.position.copy(this.trimView.position),e.commit()},this.validateTrim=()=>{const e=this.trimView.meshTrim,t=e.scale;t.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z));const s=new n.Vector3;this.currentTrimBounds.getSize(s);const i=Math.max(s.x,s.y,s.z);s.setScalar(i),s.multiplyScalar(a.aM),t.clamp(a.UM,s);const r=e.position;this.currentTrimBounds.clampPoint(r,r),e.commit()},this.controls=new r.TransformControls(this.camera,s),this.controls.name="TransformControls",this.controls.enabled=!0,this.controls.space="local",this.controls.setSize(a.JE),this.controls.addEventListener("mouseUp",this.validateTrim),e.add(this.controls);const d=this.cameraData.pose;this.orthoCam=new n.OrthographicCamera(-this.camera.fov*d.aspect(),this.camera.fov*d.aspect(),this.camera.fov,-this.camera.fov,this.camera.near,this.camera.far),this.cameraData.pose.onChanged((()=>{this.orthoCam.position.copy(d.position),this.orthoCam.quaternion.copy(d.rotation),this.orthoCam.projectionMatrix.copy(d.projection.asThreeMatrix4()),this.orthoCam.projectionMatrixInverse.copy(d.projection.asThreeMatrix4()),this.orthoCam.projectionMatrixInverse.invert(),this.orthoCam.updateMatrixWorld(!0),this.controls.camera===this.orthoCam&&this.controls.setSize(a.M2*this.cameraData.orthoZoom())}))}attachToTrim(e,t){this.controls.attach(e),this.trimView=e,this.currentTrimBounds=t}detach(){this.controls.detach()}update(){if(this.controls.dragging)switch(this.controls.getMode()){case"translate":this.updatePosition();break;case"scale":this.updateScale();break;case"rotate":this.updateRotation()}}get dragging(){return this.controls.dragging}setMode(e){this.controls.mode=e,this.controlModeObservable.value=e}getMode(){return this.controlModeObservable.value}onChanged(e){return this.controlModeObservable.onChanged(e)}setOrthoMode(){this.controls.camera=this.orthoCam,this.controls.setSize(a.M2*this.cameraData.orthoZoom())}setPerspectiveMode(){this.controls.camera=this.camera,this.controls.setSize(a.JE)}updateScale(){const e=this.trimView.meshTrim;e.scale.copy(this.trimView.scale),e.commit()}updateRotation(){const e=this.trimView.meshTrim;e.rotation.copy(this.trimView.quaternion),e.updateRotationMatrix(),e.commit()}}},63970:(e,t,s)=>{"use strict";s.d(t,{m:()=>MeshTrimView});var i=s(2212);if(984==s.j)var r=s(14092);if(984==s.j)var n=s(4901);if(984==s.j)var a=s(48653);if(984==s.j)var o=s(26603);var l=s(2210);if(984==s.j)var d=s(21918);const h=.25,c=new i.BoxGeometry(1,1,1),u=new i.MeshBasicMaterial({color:l.Q6,transparent:!0,opacity:0,side:i.FrontSide,depthTest:!1}),m=new i.MeshBasicMaterial({color:l.Q6,transparent:!0,opacity:0,side:i.BackSide,depthTest:!1});class MeshTrimView extends(984==s.j?d._:null){constructor(e,t){super(c,u.clone()),this.bindings=[],this._selected=!1,this.updateMeshTrimView=()=>{this.position.copy(this.meshTrim.position),this.quaternion.copy(this.meshTrim.rotation),this.scale.copy(this.meshTrim.scale),this.lineBox.setEnabled(this.meshTrim.enabled)},this.onClick=()=>{this.selected?this.commandBinder.issueCommand(new o.wI):this.commandBinder.issueCommand(new o.mf({meshTrimId:this.meshTrim.id}))},this.backMaterial=m.clone(),this.backMesh=new i.Mesh(c,this.backMaterial),this.add(this.backMesh),this.commandBinder=t,this.lineBox=new a.e,this.add(this.lineBox),this.name=e.id,this.renderOrder=1,this.setMeshTrimData(e)}init(){}render(e){}dispose(){this.removeBindings(),this.lineBox.dispose()}activate(e){}deactivate(e){}get selected(){return this._selected}set selected(e){this._selected=e,this.material.opacity=e?h:0,this.backMaterial.opacity=e?h:0,this.material.depthTest=!!e,this.backMaterial.depthTest=!!e,this.lineBox.setSelected(e)}setupBindings(e){this.bindings.push(e.onChanged(this.updateMeshTrimView))}removeBindings(){this.bindings.forEach((e=>e.cancel())),this.bindings.length=0}setMeshTrimData(e){this.removeBindings(),this.setupBindings(e),this.meshTrim=e,this.updateMeshTrimView()}onHover(){this.material.opacity=h,this.backMaterial.opacity=h,this.material.depthTest=!0,this.backMaterial.depthTest=!0,this.commandBinder.issueCommand(new n.u(r.C.FINGER))}onUnhover(){this.commandBinder.issueCommand(new n.u(null)),this.selected||(this.material.opacity=0,this.backMaterial.opacity=0,this.material.depthTest=!1,this.backMaterial.depthTest=!1)}onDrag(e){return!1}onDragBegin(e){return!1}}},38032:(e,t,s)=>{"use strict";s.d(t,{Um:()=>i,cY:()=>r,NB:()=>S,zx:()=>C});var i,r,n=s(2212),a=s(12216),o=s(12435),l=s(72863);function d(e,t){const s=Math.PI*t/180;return(new n.Quaternion).setFromAxisAngle(e,s)}!function(e){e.PERSPECTIVE="PERSPECTIVE_VIEW",e.SIDE="SIDE_VIEW",e.TOP="TOP_VIEW"}(i||(i={})),function(e){e.PERSPECTIVE="PERSPECTIVE",e.TOP="TOP",e.SIDE="SIDE",e.LEFT="LEFT",e.RIGHT="RIGHT"}(r||(r={}));const h=d(a.f.UP,-90),c=d(a.f.UP,90),u=d(a.f.RIGHT,-90),m=d(a.f.RIGHT,90),g=d(a.f.RIGHT,-30).multiply(d(a.f.UP,30)).multiply(d(a.f.FORWARD,-15)),p=d(a.f.RIGHT,60).multiply(d(a.f.UP,30)).multiply(d(a.f.FORWARD,-15));function v(e){return(t,s,i)=>(0,o.Q)(t,s,i,e)}const f={[i.PERSPECTIVE]:{[r.SIDE]:{nextState:i.SIDE,viewChangeFunction:l.CT},[r.TOP]:{nextState:i.TOP,viewChangeFunction:l.O7}},[i.SIDE]:{[r.TOP]:{nextState:i.TOP,viewChangeFunction:v(u)},[r.LEFT]:{nextState:i.SIDE,viewChangeFunction:v(h)},[r.RIGHT]:{nextState:i.SIDE,viewChangeFunction:v(c)},[r.PERSPECTIVE]:{nextState:i.PERSPECTIVE,viewChangeFunction:v(g)}},[i.TOP]:{[r.SIDE]:{nextState:i.SIDE,viewChangeFunction:v(m)},[r.PERSPECTIVE]:{nextState:i.PERSPECTIVE,viewChangeFunction:v(p)}}};function b(e,t){return f[e][t]||null}function S(e,t){return!!b(e,t)}function C(e,t,s,i,r){const n=b(e,t);if(!n)throw new Error("invalid state change");const{nextState:a,viewChangeFunction:o}=n;return[o(s,i,r),a]}},12435:(e,t,s)=>{"use strict";if(s.d(t,{Z:()=>a,Q:()=>o}),984==s.j)var i=s(2212);if(984==s.j)var r=s(12216);if(984==s.j)var n=s(2210);function a(e,t,s){const r=e.getSize(new i.Vector3);return e.getCenter(new i.Vector3).sub(t)[s]+Math.abs(r[s]/2)+n.sQ}function o(e,t,s,n){const o=s.rotation.clone().multiply(n).normalize(),l=a(e,t,function(e){const t=r.f.FORWARD.clone().applyQuaternion(e),s=r.f.FORWARD,i=r.f.UP;return 1===Math.round(t.dot(i))?"y":1===Math.round(t.dot(s))?"z":"x"}(o)),d=new i.Vector3(0,0,l);d.applyQuaternion(o);return{position:t.clone().add(d),rotation:o}}},2210:(e,t,s)=>{"use strict";s.d(t,{Q6:()=>r,ix:()=>n,sQ:()=>a,JB:()=>o,b5:()=>l,UM:()=>d,aM:()=>h,M2:()=>c,JE:()=>u});var i=s(2212);const r=16724312,n=16777215,a=6,o=.5,l=4,d=new i.Vector3(.2,.2,.2),h=1.5,c=.02235,u=1.35},72863:(e,t,s)=>{"use strict";s.d(t,{w1:()=>p,O7:()=>v,CT:()=>f});var i=s(2212),r=s(12216);if(984==s.j)var n=s(38032);if(984==s.j)var a=s(12435);const o=(new i.Quaternion).setFromAxisAngle(r.f.UP,Math.PI/2),l=(new i.Quaternion).setFromAxisAngle(r.f.UP,Math.PI),d=(new i.Quaternion).setFromAxisAngle(r.f.UP,0),h=(new i.Quaternion).setFromAxisAngle(r.f.UP,Math.PI/-2),c=(new i.Quaternion).setFromAxisAngle(r.f.RIGHT,Math.PI/-2);function u(e,t){const s=(0,a.Z)(e,t,"y"),r=new i.Vector3(0,s,0);return[{position:t.clone().add(r),rotation:d.clone().multiply(c)},{position:t.clone().add(r),rotation:o.clone().multiply(c)},{position:t.clone().add(r),rotation:h.clone().multiply(c)},{position:t.clone().add(r),rotation:l.clone().multiply(c)}]}function m(e,t){const s=(0,a.Z)(e,t,"x"),r=(0,a.Z)(e,t,"z"),n=new i.Vector3(s,0,0),c=new i.Vector3(0,0,r);return[{position:t.clone().add(n),rotation:o.clone()},{position:t.clone().add(c),rotation:d.clone()},{position:t.clone().sub(n),rotation:h.clone()},{position:t.clone().sub(c),rotation:l.clone()}]}function g(e,t){return t.reduce(((t,s)=>s.rotation.angleTo(e.rotation)<t.rotation.angleTo(e.rotation)?s:t),t[0])}function p(e,t,s){const i=u(e,t),r=m(e,t),a=g(s,[...i,...r]);return[a,i.includes(a)?n.Um.TOP:n.Um.SIDE]}function v(e,t,s){return g(s,u(e,t))}function f(e,t,s){return g(s,m(e,t))}},58814:(e,t,s)=>{"use strict";if(s.r(t),s.d(t,{default:()=>i.t}),984==s.j)var i=s(40291)},28900:(e,t,s)=>{"use strict";if(s.d(t,{NS:()=>n,bV:()=>a,VG:()=>o}),984==s.j)var i=s(2212);if(984==s.j)var r=s(12216);function n(){return window.innerWidth-60}function a(){return window.innerHeight-55}function o(e,t){const s=e/function(){const e=document.getElementById("#canvas-container");return e?e.offsetWidth:n()}()*2,a=new i.Vector3(0,0,0).unproject(t);return r.f.RIGHT.clone().multiplyScalar(s).unproject(t).sub(a).length()}},91934:(e,t,s)=>{"use strict";s.d(t,{s:()=>i,U:()=>r});const i="features/sweep_path_editor",r="tools/sweep_path_editor"},68223:(e,t,s)=>{"use strict";if(s.d(t,{R:()=>VisionCatalogData}),984==s.j)var i=s(32770);class VisionCatalogData extends(984==s.j?i.V:null){constructor(e=[]){super(),this.catalog=e}get semantic(){return this.catalog.find((e=>"semantic"===e.name))}get detectedObjects(){return this.catalog.find((e=>"detectedObjects"===e.name))}get objectBlur(){return this.catalog.find((e=>"objectBlur"===e.name))}}},12879:(e,t,s)=>{"use strict";if(s.d(t,{o:()=>VisionCatalogModule}),984==s.j)var i=s(47724);if(984==s.j)var r=s(68223);if(984==s.j)var n=s(64707);class VisionCatalogModule extends(984==s.j?i.Y:null){constructor(){super(...arguments),this.name="vision-catalog"}async init(e={},t){const s=new n.o,i=await s.read().catch((e=>(this.log.info("Failed to load Vision Catalog"),[])));this.data=new r.R(i),t.market.register(this,r.R,this.data)}dispose(e){super.dispose(e),e.market.unregister(this,r.R)}}},64707:(e,t,s)=>{"use strict";if(s.d(t,{o:()=>VisionCatalogStore}),984==s.j)var i=s(33359);if(984==s.j)var r=s(55594);if(984==s.j)var n=s(94474);if(984==s.j)var a=s(31879);class VisionCatalogStore extends(984==s.j?n.u:null){async read(){return this._readAssets().then((e=>e.length?e:this._readCatalog()))}_readAssets(){const e={modelId:this.getViewId()};return this.query(i.GetVisionAssets,e).then((e=>{var t;const s=(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||{},i=[];for(const e in s){const t=s[e];t.url&&i.push({name:e,contentType:t.contentType||"unknown",format:t.format,url:t.url,validUntil:(0,a.p)(t.validUntil)})}return i}))}_readCatalog(){const e={modelId:this.getViewId()};return this.query(r.GetVisionCatalog,e).then((e=>{var t,s,i;const r=(null===(i=null===(s=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===s?void 0:s.assets)||void 0===i?void 0:i.catalog)||[],n=[];return r.forEach((e=>{if(e.url){let t=e.type||"unknown";"unknown"===t&&e.url.match(/blur/i)&&(t="objectBlur"),"unknown"===t&&e.url.match(/detected/i)&&(t="detectedObjects"),n.push({name:t,format:e.format,url:e.url,contentType:e.format,validUntil:(0,a.p)(e.validUntil)})}})),n}))}}},32226:(e,t,s)=>{"use strict";if(s.r(t),s.d(t,{default:()=>i.o}),984==s.j)var i=s(12879)},75634:(e,t,s)=>{"use strict";if(s.d(t,{K:()=>n,Q:()=>ObservableMapFilter}),984==s.j)var i=s(66209);if(984==s.j)var r=s(44283);var n;!function(e){e.LOW="low",e.NORMAL="normal"}(n||(n={}));class ObservableMapFilter extends(984==s.j?i.y:null){constructor(e){super(),this.priority=n.NORMAL,this.filters=new Map,this.view=[],this._keys=new Set,this._dirty=!1,this.map=e,this.applyFilters(),this.map.onElementChanged({onAdded:(e,t)=>this.onAdded(t,e),onRemoved:(e,t)=>this.onRemoved(t,e),onUpdated:(e,t)=>this.applyFilters(t)})}has(e){return this._keys.has(e)}get(e){return this.has(e)?this.map.get(e):void 0}setFilter(e,t){return(0,r.k1)((()=>{this.filters.set(e,t),this.applyFilters()}),(()=>this.clearFilter(e)),!0)}clearFilter(e){return!!this.filters.has(e)&&(this.filters.delete(e),this.applyFilters(),!0)}clearFilters(){this.filters.clear(),this.applyFilters()}sort(e){this.compareFunc=e,this.applySort(),this.setDirty()}*[Symbol.iterator](){for(const e of this.view)yield e}get length(){return this.view.length}groupBy(e){const t={};for(const s of this.view){const i=String(s[e]);t[i]||(t[i]=[]),t[i].push(s)}return t}setDirty(e=!0){this.priority===n.LOW?this._dirty||(this._dirty=!0,requestAnimationFrame((()=>{this._dirty=!1,super.setDirty(e)}))):super.setDirty(e)}add(e){return!this.has(e)&&(this._keys.add(e),this.view.push(this.map.get(e)),!0)}delete(e){if(!this.has(e))return!1;this._keys.delete(e);const t=this.map.get(e),s=this.view.indexOf(t);return-1!==s&&this.view.splice(s,1),!0}testFilters(e){return[...this.filters.values()].every((t=>t(e)))}applyFilters(e){let t=!1;for(const e of this.map.keys){const s=this.map.get(e),i=this.testFilters(s);(i&&this.add(e)||!i&&this.delete(e))&&(t=!0)}e&&this.has(e)&&(t=!0),t&&(this.applySort(),this.setDirty())}applySort(){this.compareFunc&&this.view.sort(this.compareFunc)}onRemoved(e,t){if(!this.has(e))return;this._keys.delete(e);const s=this.view.findIndex((e=>e===t));-1!==s&&this.view.splice(s,1),this.setDirty()}onAdded(e,t){this.testFilters(t)&&this.applyFilters(e)}}},49540:(e,t,s)=>{"use strict";s.d(t,{r:()=>DomSubscription});class DomSubscription{constructor(e,t,s,i){this.target=e,this.type=t,this.listener=s,this.options=i,this.renew()}renew(){this.target.addEventListener(this.type,this.listener,this.options)}cancel(){this.target.removeEventListener(this.type,this.listener)}}},11369:(e,t,s)=>{"use strict";s.d(t,{x:()=>Blur});var i=s(23573),r=s(10757),n=s(6989);class Blur extends i.T{constructor(e){super(),this.dots=[],this.status=n.Q.PENDING,this.floorId=null,this.roomId=null,this.visible=!0,this.created=new Date,this.modified=new Date,this.id=(0,r.O1)(11),this.index=-1,e&&Object.assign(this,e)}get editable(){return Blur.editableStatus.includes(this.status)}add(e,t,s,i){let r=this.dots.find((e=>e.radius===t&&e.feather===s&&e.strength===i));r||(r={radius:t,feather:s,strength:i,directions:[]},this.dots.push(r)),r.directions.push(e),this.modified.setTime(Date.now()),this.commit()}static from(e){return new Blur({status:n.Q.PENDING,dots:e.dots,sweepId:e.sweepId,floorId:e.floorId||null})}get dotCount(){return this.dots.reduce(((e,t)=>e+t.directions.length),0)}get sid(){return this.id}}Blur.editableStatus=[n.Q.FAILED,n.Q.PENDING]},54434:(e,t,s)=>{"use strict";if(s.d(t,{f:()=>BlurData}),984==s.j)var i=s(32770);if(984==s.j)var r=s(64781);if(984==s.j)var n=s(48715);if(984==s.j)var a=s(10757);var o=s(88512);if(984==s.j)var l=s(6989);new o.Z("BlurData");class BlurData extends(984==s.j?i.V:null){constructor(e){super(),this.name="blur-data",this.blurs=new r.v,this._hasProcessing=new n.f(!1),this._hasUnapplied=new n.f(!1),e&&this.add(...Object.values(e))}add(...e){this.atomic((()=>{this.blurs.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.blurs.has(t.id);)t.id=(0,a.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.blurs.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.blurs.set(t.id,t)})),this.update(),this.commit()}))}delete(...e){return this.atomic((()=>{this.blurs.atomic((()=>{e.filter((e=>this.isEditable(e)&&this.blurs.delete(e)))})),this.update(),this.commit()})),e.length}get(e){return this.blurs.get(e)}getEditable(){return this.blurs.values.filter((e=>e.editable))}getBySweepId(e,t=null){return this.blurs.values.filter((s=>s.sweepId===e&&(null===t||s.visible===t)))}getByStatus(...e){return e.length?this.blurs.values.filter((t=>e.includes(t.status))):this.blurs.values}batchToggleVisibility(e){const t=e.some((e=>{const t=this.blurs.get(e);return!!t&&!t.visible}));for(const s of e){const e=this.blurs.get(s);e&&(e.visible=t,e.commit())}}has(e){return this.blurs.has(e)}hasIndex(e){return!!this.blurs.values.find((t=>t.index===e))}hasStatus(e){return this.blurs.values.some((t=>t.status===e))}hasUnappliedBlurs(){return this.blurs.values.some((e=>e.status===l.Q.PENDING||e.status===l.Q.FAILED))}hasAppliedBlurs(){return this.blurs.values.some((e=>e.status===l.Q.PROCESSING||e.status===l.Q.APPLIED||e.status===l.Q.FAILED))}hasProcessingBlurs(){return this.hasStatus(l.Q.PROCESSING)}setVisibility(e,...t){this.atomic((()=>{this.blurs.atomic((()=>{for(const s of t)if(this.has(s)){const t=this.blurs.get(s);t.visible=e,t.modified.setTime(Date.now()),t.commit()}})),this.commit()}))}setStatus(e,...t){this.atomic((()=>{this.blurs.atomic((()=>{for(const s of t)if(this.has(s)){const t=this.blurs.get(s);t.status=e,t.modified.setTime(Date.now()),t.commit()}})),this.update(),this.commit()}))}isEditable(e){if(!this.has(e))return!1;return this.get(e).editable}makeProcessingSubscription(e){return this._hasProcessing.onChanged(e)}makeUnappliedSubscription(e){return this._hasUnapplied.onChanged(e)}update(){let e=!1;const t=this.hasProcessingBlurs();t!==this._hasProcessing.value&&(this._hasProcessing.value=t,e=!0);const s=this.hasUnappliedBlurs();s!==this._hasUnapplied.value&&(this._hasUnapplied.value=s,e=!0),e&&this.commit()}onChanged(e){return super.onChanged(e)}}},44585:(e,t,s)=>{"use strict";if(s.d(t,{Z:()=>BlurDataModule}),984==s.j)var i=s(47724);if(984==s.j)var r=s(39729);if(984==s.j)var n=s(71194);if(984==s.j)var a=s(57361);if(984==s.j)var o=s(6989);if(984==s.j)var l=s(33394);if(984==s.j)var d=s(12040);if(984==s.j)var h=s(50988);if(984==s.j)var c=s(38420);if(984==s.j)var u=s(26587);if(984==s.j)var m=s(48602);if(984==s.j)var g=s(75892);if(984==s.j)var p=s(54434);if(984==s.j)var v=s(67467);if(984==s.j)var f=s(48618);if(984==s.j)var b=s(20799);var S=s(13789);if(984==s.j)var C=s(43993);if(984==s.j)var T=s(51433);const{BLURS:w}=S.Z.WORKSHOP;class BlurDataModule extends(984==s.j?i.Y:null){constructor(){super(...arguments),this.name="blur_data",this.refreshPromise=null,this.onSaveBlursCommand=()=>{const{commandBinder:e}=this.engine;return e.issueCommand(new h.VQ({dataTypes:[c.g.BLURS]}))},this.onApplyBlursCommand=()=>{const{commandBinder:e}=this.engine;return e.issueCommand(new h.R_({dataTypes:[c.g.BLURS]}))}}async init(e,t){this.engine=t,this.config=e,this.load(t)}dispose(e){super.dispose(e),e.market.unregister(this,p.f)}async configureStorage(){if(this.store)return;const{baseUrl:e,modelId:t,queue:s,readonly:i}=this.config,{commandBinder:r,market:n}=this.engine,a=await n.waitForData(g.Z);this.store=new b.D({baseUrl:e,modelId:t,queue:s,sweepData:a}),i||(this.bindings.push(r.addBinding(v.s$,(()=>this.refresh())),r.addBinding(v.Mh,this.onApplyBlursCommand),r.addBinding(v.o8,this.onSaveBlursCommand),r.addBinding(v.TL,(async({ids:e})=>this.deleteById(...e)))),this.engine.getModule(u.F).then((e=>{this.bindings.push(e.onPublish((()=>this.applyBlurs()),{phase:c.Q.BEFORE}),e.onPublish((()=>this.updatePublishableStatus()),{phase:c.Q.AFTER}),e.onRevert((()=>this.revert()),{dataType:c.g.BLURS}),e.onSave((()=>this.save()),{dataType:c.g.BLURS}))})))}async load(e){await this.configureStorage(),this.settings=await e.getModule(C.default),this.data=new p.f;const t=await this.store.read()||{};return this.data.add(...Object.values(t)),e.market.register(this,p.f,this.data),this.monitor=new a.c(this.data.blurs,{aggregationType:r.E.Manual}),this.updatePublishableStatus(),t}async updatePublishableStatus(){const e=await this.engine.market.waitForData(m.Q);this.data.hasUnappliedBlurs()&&!this.data.hasProcessingBlurs()?e.setUnpublished(c.g.BLURS):e.clearUnpublished(c.g.BLURS)}async refresh(){if(this.refreshPromise)return;if(!this.data.hasAppliedBlurs())return;const e=this.store.read().then((e=>{this.updateBlursFrom(...Object.values(e||{}))})).finally((()=>{this.refreshPromise=null}));return this.refreshPromise=e,e}async save(){if(!this.monitor||this.config.readonly)return void this.log.warn("Blur changes will NOT be saved");await this.refresh(),this.monitor.commitChanges();const e=this.monitor.getDiffRecord().filter((({index:e,action:t})=>t===n.KI.removed||this.data.has(e)&&this.data.get(e).editable));if(this.monitor.clearDiffRecord(),!e.length)return;const t={};for(const s of e)switch(s.action){case n.KI.added:case n.KI.updated:t[s.index]=this.data.get(s.index);break;case n.KI.removed:t[s.index]=null}return this.store.update(t).catch((e=>{this.log.error(e);const t=w.UNABLE_TO_SAVE_CHANGES_ERROR_MESSAGE;this.engine.commandBinder.issueCommand(new l.I(t,{throttle:30,type:d.N.ERROR}))}))}async applyBlurs(e=!0){if(this.data.hasProcessingBlurs())return;return!e||await(0,f.O)(this.data,this.engine.commandBinder)?this.publish():void 0}async publish(){var e,t,s;if(this.data.hasProcessingBlurs())return;await this.save();const i=this.data.getByStatus(o.Q.PENDING,o.Q.FAILED);if(!i.length)return;i.length>T.Dr&&(this.log.info(`Publishing Blurs: Truncating request to the maximum of ${T.Dr} Blurs. Total Pending: ${i.length}`),i.length=T.Dr),this.data.setStatus(o.Q.PROCESSING,...i.map((e=>e.id))),this.log.info(`Applying ${i.length} blurs...`);const r=null===(e=this.settings)||void 0===e?void 0:e.tryGetProperty(T.n5,!1),n=null===(t=this.settings)||void 0===t?void 0:t.tryGetProperty(T.i7,!1),a=null===(s=this.settings)||void 0===s?void 0:s.tryGetProperty(T.pv,!1);return this.store.apply(i,{useChunks:a,meshBlurEnabled:n,pipelineEnabled:r}).catch((e=>{let t=w.UNABLE_TO_APPLY_BLURS_ERROR_MESSAGE;"status_code"in e&&403===e.status_code&&(t=w.UNAUTHORIZED_ERROR_MESSAGE),this.engine.commandBinder.issueCommand(new l.I(t,{timeout:0,type:d.N.ERROR}))})).finally((()=>{this.updatePublishableStatus()}))}async revert(){const e=this.data.getByStatus(o.Q.PENDING).map((e=>e.id));if(e.length)return this.data.delete(...e),this.save()}async deleteById(...e){if(this.data.delete(...e))return this.save()}updateBlursFrom(...e){this.data.atomic((()=>{e.forEach((e=>{if(this.data.has(e.id)){const t=this.data.get(e.id);e.status!==t.status&&(t.status=e.status,t.modified.setTime(e.modified.getTime()),t.commit())}}))})),this.updatePublishableStatus()}}},6989:(e,t,s)=>{"use strict";var i;s.d(t,{Q:()=>i}),function(e){e.PENDING="pending",e.PROCESSING="processing",e.APPLIED="applied",e.FAILED="failed"}(i||(i={}))},67467:(e,t,s)=>{"use strict";if(s.d(t,{TL:()=>DeleteBlursCommand,o8:()=>SaveBlursCommand,ie:()=>PublishBlursCommand,s$:()=>RefreshBlursCommand,Mh:()=>ApplyBlursCommand}),984==s.j)var i=s(17386);class DeleteBlursCommand extends(984==s.j?i.m:null){constructor(...e){super(),this.id="DELETE_BLURS",this.payload={ids:e}}}class SaveBlursCommand extends(984==s.j?i.m:null){constructor(){super(...arguments),this.id="SAVE_BLURS"}}class PublishBlursCommand extends(984==s.j?i.m:null){constructor(){super(...arguments),this.id="PUBLISH_BLURS_COMMAND"}}class RefreshBlursCommand extends(984==s.j?i.m:null){constructor(){super(...arguments),this.id="REFRESH_BLURS_COMMAND"}}class ApplyBlursCommand extends(984==s.j?i.m:null){constructor(e={}){super(),this.id="APPLY_BLURS_COMMAND",this.payload={confirm:!("confirm"in e)||!!e.confirm}}}},48618:(e,t,s)=>{"use strict";s.d(t,{O:()=>g});var i=s(85893);if(984==s.j)var r=s(48410);if(984==s.j)var n=s(79394);var a=s(13789);if(984==s.j)var o=s(6989);if(984==s.j)var l=s(59417);if(984==s.j)var d=s(51433);const{BLURS:h,SCANS:c,MODAL:u}=a.Z.WORKSHOP;function m({sweepCount:e,blurCount:t,failedBlurCount:s}){const r=(0,l.b)(),n=r.t(c.NUM_TYPE,e),a=r.t(h.NUM_TYPE,t),o=r.t(h.APPLY_MODAL_MESSAGE,{scans:n,blurs:a}),u=r.t(h.APPLY_MODAL_WARNING);let m;s>0&&(m=r.t(h.APPLY_MODAL_RETRY));const g=t>d.Dr&&r.t(h.APPLY_MODAL_TRUNCATED,{blurs:a,maxBlurs:d.Dr});return(0,i.jsxs)("div",{children:[(0,i.jsx)("p",{dangerouslySetInnerHTML:{__html:o}},void 0),(0,i.jsx)("p",{dangerouslySetInnerHTML:{__html:u}},void 0),m&&(0,i.jsx)("p",{dangerouslySetInnerHTML:{__html:m}},void 0),g&&(0,i.jsx)("p",{dangerouslySetInnerHTML:{__html:g}},void 0)]},void 0)}const g=async(e,t)=>{if(!e.hasUnappliedBlurs())return!1;const s=e.getByStatus(o.Q.PENDING,o.Q.FAILED),a=e.getByStatus(o.Q.FAILED),l=new Set(s.map((e=>e.sweepId))),d={title:h.APPLY_MODAL_TITLE,message:(0,i.jsx)(m,{sweepCount:l.size,blurCount:s.length,failedBlurCount:a.length},void 0),cancellable:!0,confirmPhraseKey:h.APPLY_MODAL_CONFIRM,cancelPhraseKey:u.NO,modalClass:"blur-tool-modal"};return await t.issueCommand(new n.Q(n.f.DISPLAY,d))===r.U.CONFIRM}},15044:(e,t,s)=>{"use strict";if(s.r(t),s.d(t,{ApplyBlursCommand:()=>i.Mh,DeleteBlursCommand:()=>i.TL,PublishBlursCommand:()=>i.ie,RefreshBlursCommand:()=>i.s$,SaveBlursCommand:()=>i.o8,BlurData:()=>r.f,BlurStatus:()=>n.Q,Blur:()=>a.x,default:()=>o.Z}),984==s.j)var i=s(67467);if(984==s.j)var r=s(54434);if(984==s.j)var n=s(6989);if(984==s.j)var a=s(11369);if(984==s.j)var o=s(44585)},81574:(e,t,s)=>{"use strict";s.d(t,{g:()=>i,U:()=>r});const i=984==s.j?9e4:null,r=1},20799:(e,t,s)=>{"use strict";if(s.d(t,{D:()=>BlurStore}),984==s.j)var i=s(38330);if(984==s.j)var r=s(10757);var n=s(88512);if(984==s.j)var a=s(51433);if(984==s.j)var o=s(59838);if(984==s.j)var l=s(2445);const d=new n.Z("BlurStore");class BlurStore extends(984==s.j?i.MU:null){constructor(e){const{baseUrl:t,modelId:s,queue:i,sweepData:r}=e;super({queue:i,path:`${t}/api/v1/jsonstore/model/blurs/${s}`,batchUpdate:!0,deserialize:(0,o.B4)(r),serialize:(0,l.fM)(r)}),this.queue=i,this.baseUrl=t,this.modelId=s,this.serialize=(0,l.o2)(r)}async apply(e,{useChunks:t,meshBlurEnabled:s,pipelineEnabled:i}){if(!i)return void d.info("Pipeline disabled, no blurs will be applied to the model");const n={enableMeshBlur:s,levels:a.TW.map((e=>({size:e.size,sigmaRadians:.5*e.sigma/e.size})))},o={};for(const s of e){const e=t?s.sweepId:0,i=this.serialize(s);i&&(o[e]||(o[e]={}),o[e][s.id]=i)}const l=Object.keys(o).length,h=[];for(const e in o){const s=o[e];t&&d.debug(`Applying ${Object.values(s).length} blurs to Sweep ${e}`);const i=this.queue.post(`${this.baseUrl}/api/v2/pano-edit/${this.modelId}/blur-panos`,{withCredentials:!0,body:{blurs:s,options:n}});h.push(i),l>h.length&&(d.debug("waiting 100ms"),await(0,r.gw)(250))}return Promise.all(h)}}},59838:(e,t,s)=>{"use strict";if(s.d(t,{B4:()=>u,LB:()=>m}),984==s.j)var i=s(31879);var r=s(88512);if(984==s.j)var n=s(19674);if(984==s.j)var a=s(11369);if(984==s.j)var o=s(6989);if(984==s.j)var l=s(81574);if(984==s.j)var d=s(30839);if(984==s.j)var h=s(35026);const c=new r.Z("blurDeserializer");function u(e){const t=function(e){return function(t){var s;const r=m(null==t?void 0:t.dots),n=e.getSweepByUuid(null===(s=null==t?void 0:t.sweepId)||void 0===s?void 0:s.replace(/-/g,""));if(!(t&&r&&r.length&&n))return c.debug("Deserialized invalid Blur",t),null;const d=new a.x({id:t.sid,index:"number"==typeof t.index?t.index:-1,status:t.status,sweepId:n.id,created:(0,i.p)(t.created)});return n.placementType!==h.hU.UNPLACED&&(d.floorId=n.floorId,d.roomId=n.roomId),r.forEach((e=>{e.directions.forEach((t=>{d.add(t,e.radius,e.feather,e.strength)}))})),d.modified=(0,i.p)(t.modified),d.status===o.Q.PROCESSING&&Date.now()-d.modified.getTime()>l.g&&(d.status=o.Q.FAILED),d}}(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[e.id]=e)}return s}}function m(e){if(!e||!Array.isArray(e))return null;const t=[];for(const s of e)if(g(s)){const e=s.unitVectors.map((e=>n.ep.fromVisionVector({x:"string"==typeof e.x?parseFloat(e.x):e.x,y:"string"==typeof e.y?parseFloat(e.y):e.y,z:"string"==typeof e.z?parseFloat(e.z):e.z})));t.push({directions:e,radius:(0,d.d)(s.radius),feather:"string"==typeof s.feather?parseFloat(s.feather):s.feather,strength:"string"==typeof s.strength?parseFloat(s.strength):s.strength})}return t}function g(e){return["unitVectors","radius","strength","feather"].every((t=>t in e))}},2445:(e,t,s)=>{"use strict";if(s.d(t,{o2:()=>o,fM:()=>l,o_:()=>d}),984==s.j)var i=s(31879);if(984==s.j)var r=s(19674);if(984==s.j)var n=s(87324);if(984==s.j)var a=s(30839);function o(e){return function(t){if(!t)return null;const s=e.getSweep(t.sweepId),r=d(t.dots);if(!s||!(null==r?void 0:r.length))return null;return{sid:t.id,index:t.index,sweepId:s.uuid,status:t.status,dots:r,visible:t.visible,created:(0,i.U)(t.created),modified:(0,i.U)(t.modified)}}}function l(e){const t=o(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[i.id]=e)}return s}}function d(e){if(!e)return null;return function(e,t=5){return e.map((e=>({unitVectors:e.unitVectors.map((e=>({x:(0,r.Zd)(e.x,t),y:(0,r.Zd)(e.y,t),z:(0,r.Zd)(e.z,t)}))),radius:(0,r.Zd)(e.radius,t),feather:(0,r.Zd)(e.feather,t),strength:(0,r.Zd)(e.strength,3)})))}(e.map((e=>({unitVectors:e.directions.map((e=>(0,n.m)(r.ep.toVisionVector(e)))),radius:(0,a.t)(e.radius),feather:e.feather,strength:e.strength}))))}},30839:(e,t,s)=>{"use strict";if(s.d(t,{t:()=>r,d:()=>n}),984==s.j)var i=s(81574);function r(e){return Math.atan(e/i.U)}function n(e){return i.U*Math.tan(e)}},7514:(e,t,s)=>{"use strict";s.d(t,{Z:()=>r});var i=s(67294);function r(){const[,e]=(0,i.useState)(0);return(0,i.useCallback)((()=>{e((e=>e+1))}),[])}},66354:(e,t,s)=>{"use strict";s.d(t,{Z:()=>n});var i=s(67294);if(984==s.j)var r=s(7514);function n(e){const t=(0,r.Z)();return(0,i.useEffect)((()=>{t();const s=e.onChanged(t);return()=>{s.cancel()}}),[e,t]),e}},15425:(e,t,s)=>{"use strict";s.d(t,{t:()=>m});var i=s(85893),r=s(67294),n=s(94184),a=s.n(n),o=s(2116),l=s(44750),d=s(84533),h=s(87038),c=s(65225),u=function(e,t,s,i){var r,n=arguments.length,a=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,s,a):r(t,s))||a);return n>3&&a&&Object.defineProperty(t,s,a),a};let m=class AccordionSelectorContent extends r.Component{render(){const{children:e,selectMode:t}=this.props;return(0,i.jsx)("div",Object.assign({className:a()("accordion-main-content",{"footer-active":t})},{children:(0,i.jsx)(h.Z,Object.assign({direction:l.Nm.vertical,hideScrollbar:(0,d.w)(window)},{children:(0,i.jsx)(c.F,{children:e},void 0)}),void 0)}),void 0)}};m=u([o.Z],m)},84376:(e,t,s)=>{"use strict";s.d(t,{n:()=>AccordionSelectorFooter});var i=s(85893),r=s(67294),n=s(94184),a=s.n(n),o=s(25813),l=s(47210),d=s(13789);const{TOGGLE_VISIBILITY_FOOTER_CTA:h,DELETE_FOOTER_CTA:c}=d.Z.WORKSHOP.ACCORDION;class AccordionSelectorFooter extends r.Component{renderFooterButton(e,t,s){const{locale:r}=this.context,n=this.props.enabled&&!s,a=r.t(e);return(0,i.jsx)("span",Object.assign({className:"footer-button-container"},{children:(0,i.jsx)(l.zx,Object.assign({buttonStyle:l.ZJ.CLEAR,buttonSize:l.qE.MINI,buttonState:n?l.BN.ENABLED:l.BN.DISABLED,onClick:t},{children:a}),void 0)}),void 0)}render(){const{active:e,leftButtonPhraseKey:t=c,leftButtonCallback:s,leftButtonDisabled:r=!1,rightButtonPhraseKey:n=h,rightButtonCallback:o,rightButtonDisabled:l=!1}=this.props,d={active:e},u=this.renderFooterButton(t,s,r),m=this.renderFooterButton(n,o,l);return(0,i.jsx)("div",Object.assign({className:a()("accordion-selector-footer",d)},{children:(0,i.jsxs)("div",Object.assign({className:"footer-list"},{children:[u,m]}),void 0)}),void 0)}}AccordionSelectorFooter.contextType=o.I},57474:(e,t,s)=>{"use strict";s.d(t,{y:()=>AccordionSelectorHeader});var i=s(85893),r=s(67294),n=s(94184),a=s.n(n),o=s(25813),l=s(47210),d=s(13789);const{DELETE_SELECTED_CTA:h,SELECT_ALL_CTA:c,ENTER_SELECT_MODE_CTA:u,EXIT_SELECT_MODE_CTA:m}=d.Z.WORKSHOP.ACCORDION;class AccordionSelectorHeader extends r.Component{render(){const{locale:e}=this.context,{title:t,hasSelectedItems:s,selectMode:r,selectAllCallback:n,selectButtonCallback:o,batchSupported:d,disableToggle:g}=this.props;if(!t&&!d)return null;const p={"select-mode":r},v=e.t(s?h:c),f=e.t(r?m:u);return(0,i.jsxs)("div",Object.assign({className:a()("accordion-selector-header",p)},{children:[(0,i.jsx)("span",Object.assign({className:"title"},{children:r?(0,i.jsx)(l.zx,Object.assign({buttonSize:l.qE.MINI,buttonStyle:l.ZJ.CLEAR,onClick:n},{children:v}),void 0):t}),void 0),d&&(0,i.jsx)(l.zx,Object.assign({buttonSize:l.qE.MINI,buttonStyle:r?l.ZJ.CLEAR:l.ZJ.LIGHT,buttonState:g?l.BN.DISABLED:l.BN.ENABLED,onClick:o},{children:f}),void 0)]}),void 0)}}AccordionSelectorHeader.contextType=o.I},13646:(e,t,s)=>{"use strict";s.d(t,{Z:()=>c});var i=s(85893),r=s(67294),n=s(94184),a=s.n(n);if(984==s.j)var o=s(25813);if(984==s.j)var l=s(36114);if(984==s.j)var d=s(47210);if(984==s.j)var h=s(33746);function c(e){const{locale:t}=(0,r.useContext)(o.I),{id:s,visible:n,showTooltip:c,hideTooltip:u,forceDisable:m,tooltipPosition:g}=e,p=n?"icon-eye-show":"icon-eye-hide",v=n&&!m?d.BN.ENABLED:d.BN.DIMMED,f=m?void 0:t.t(n?u:c),b=m?()=>{}:e.onClick;return(0,i.jsx)(l.hU,{className:a()("accordion-icon","accordion-item-toggle-icon"),iconClass:p,buttonStyle:l.Dd.PLAIN,buttonState:v,tooltipMsg:f,tooltipPosition:g||h.lZ.DOWN_RIGHT,dataValue:s,onClick:b,breakoutTooltip:!0},void 0)}},39428:(e,t,s)=>{"use strict";s.d(t,{A:()=>a});var i=s(85893),r=s(67294);const n=()=>!0;function a(e,t=n){return class WithBatchSelect extends r.Component{constructor(e){super(e),this.toggleSelectMode=()=>{const{selectMode:e}=this.state;this.setState({checkedItems:new Set,selectMode:!e})},this.setGroupExpandState=(e,t)=>{const{expandedGroups:s}=this.state;s[e]=t,this.setState({expandedGroups:Object.assign({},s)})},this.onCheckboxClick=e=>{const t=e.dataset.value;t&&this.checkItem(t)},this.checkItem=e=>{e&&this.toggleId(e)},this.checkGroup=e=>{const s=e.items.every((e=>this.state.checkedItems.has(e.sid)||!t(e,this.props)));for(const i of e.items)t(i,this.props)&&this.setId(i.sid,!s,!1);this.setState({checkedItems:new Set(this.state.checkedItems)})},this.toggleId=e=>{const t=this.state.checkedItems.has(e);this.setId(e,!t)},this.clearSelected=()=>{this.setState({checkedItems:new Set})},this.setId=(e,t,s=!0)=>{t?this.state.checkedItems.add(e):this.state.checkedItems.delete(e),s&&this.setState({checkedItems:new Set(this.state.checkedItems)})},this.isGroupBatchSelected=e=>{if(!e)return!1;const s=e.items;if(!s||s.length<=0)return!1;const{checkedItems:i}=this.state;return s.every((e=>i.has(e.sid)||!t(e,this.props)))},this.toggleAll=e=>{const{checkedItems:s}=this.state,i=0===s.size;for(const s in e){const r=e[s].items;for(const e of r)t(e,this.props)&&this.setId(e.sid,i,!1)}this.setState({checkedItems:new Set(this.state.checkedItems)})},this.state={expandedGroups:{},checkedItems:new Set,selectMode:!1}}render(){const{checkedItems:t,selectMode:s,expandedGroups:r}=this.state;return(0,i.jsx)(e,Object.assign({},this.props,{onCheckboxClick:this.onCheckboxClick,onSelectItem:this.checkItem,onSelectGroup:this.checkGroup,onSelectAll:this.toggleAll,clearSelected:this.clearSelected,toggleSelectMode:this.toggleSelectMode,selectMode:s,selectedItems:t,expandedGroups:r,onExpandChange:this.setGroupExpandState,isGroupBatchSelected:this.isGroupBatchSelected}),void 0)}}}},21302:(e,t,s)=>{"use strict";s.d(t,{K:()=>b});var i,r=s(85893),n=s(67294),a=s(2116),o=s(94184),l=s.n(o),d=s(25813),h=s(91215),c=s(27326),u=s(3375),m=s(13789),g=s(67196),p=s(96005),v=function(e,t,s,i){var r,n=arguments.length,a=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,s,a):r(t,s))||a);return n>3&&a&&Object.defineProperty(t,s,a),a};const{RENAME_HEADER_OPTION_CTA:f}=m.Z.WORKSHOP.ACCORDION;let b=i=class FloorRenameHeader extends n.Component{constructor(e){super(e),this.bindings=[],this.registerOnNameChanged=e=>{this.floorsViewData=e;const{group:t}=this.props;try{const s=e.getFloor(t.id),i=e.getDefaultFloorName(t.id);this.setState({renamable:!0,defaultName:i}),this.bindings.push(s.onPropertyChanged("name",this.onNameChanged)),this.onNameChanged(s.name)}catch(e){}},this.onNameChanged=e=>{if(this.floorsViewData){const t=this.floorsViewData.getFloorName(this.props.group.id),s=()=>this.setState({actualName:e,displayName:t});t===this.state.displayName?this.setState({actualName:e,displayName:e},s):s()}},this.onCheckboxClick=e=>{const{group:t,onSelectGroup:s}=this.props;s&&s(t)},this.startRename=()=>{this.setState({renaming:!0})},this.renameFloor=e=>{this.context.commandBinder.issueCommand(new h.M(this.props.group.id,e)),this.setState({renaming:!1})},this.cancelRename=()=>{this.setState({renaming:!1})},this.toggleExpanded=e=>{const t=e.target;this.props.onToggle&&!t.classList.contains("icon-more-vert")&&this.props.onToggle()},this.getMenuOptions=()=>[[f,this.startRename]],this.state={renamable:!1,actualName:this.props.group.name,displayName:this.props.group.name,renaming:!1}}componentDidMount(){const{market:e}=this.context;e.waitForData(c.c).then(this.registerOnNameChanged)}componentWillUnmount(){for(const e of this.bindings)e.cancel()}render(){const{group:e,multiFloor:t,selectMode:s,isGroupSelected:n,headerSuffix:a}=this.props,{items:o,id:d}=e,{actualName:h,defaultName:c,displayName:m,renamable:v,renaming:f}=this.state,b={"with-children":!!s,"accordion-header-editing":f,"accordion-collapsible":t,"accordion-header-select-mode":s},S=a||`(${o.length})`;return(0,r.jsxs)("div",Object.assign({className:l()("accordion-header","floor-rename-header",b),onClick:this.toggleExpanded},{children:[s&&(0,r.jsx)("div",Object.assign({className:"accordion-checkbox"},{children:(0,r.jsx)(g.X,{enabled:o.length>0,checked:n,id:d,onChange:this.onCheckboxClick,stopPropagation:!0,dataValue:d},void 0)}),void 0),(0,r.jsx)(u.Z,{isDisabled:!1,editing:f,className:"accordion-header-label",text:f?h:m,placeholder:c,hint:S,clickToEdit:!1,closeOnFocusOut:!0,onEdited:this.renameFloor,maxLength:i.maxFloorNameLength,showUnderline:f,readOnlyMode:!f,propagateMouseEvent:!f,onCancelEditing:this.cancelRename},void 0),t&&(0,r.jsx)("button",{className:"icon accordion-icon accordion-toggle-icon"},void 0),v&&!s&&!f&&(0,r.jsx)(p.e,{id:d,menu:this.getMenuOptions()},void 0)]}),void 0)}};b.contextType=d.I,b.maxFloorNameLength=24,b.focusedFloor=-1,b=i=v([a.Z],b)},53694:(e,t,s)=>{"use strict";s.d(t,{r:()=>MeshTrim});var i=s(23573),r=s(10757),n=s(2212);class MeshTrim extends i.T{constructor(e,t,s,i,a,o,l=new Date,d=new Date,h,c,u,m){super(),this.position=e,this.scale=t,this.rotation=s,this.enabled=a,this.meshGroup=o,this.created=l,this.modified=d,this.discardContents=!0,this.activeInPanoMode=!0,this._rotationMatrix=new n.Matrix4,this.id=h||`${this.meshGroup}`+(0,r.O1)(11),this.index=i,this.name=c,this.discardContents=void 0===u||u,this.activeInPanoMode=void 0===m||m}get sid(){return this.id}updateRotationMatrix(){const e=this.rotation,t=this.rotation.clone().set(e.x,e.y,e.z,-e.w);this._rotationMatrix.makeRotationFromQuaternion(t.normalize())}get rotationMatrix(){return this.updateRotationMatrix(),this._rotationMatrix}}},65989:(e,t,s)=>{"use strict";s.d(t,{A:()=>CreateMeshTrimCommand,yg:()=>DeleteMeshTrimCommand,dg:()=>MoveMeshTrimToAllFloorsCommand});var i=s(17386);class CreateMeshTrimCommand extends i.m{constructor(e){super(),this.payload=e,this.id="CREATE_MESH_TRIM"}}class DeleteMeshTrimCommand extends i.m{constructor(e){super(),this.payload=e,this.id="DELETE_MESH_TRIM"}}class MoveMeshTrimToAllFloorsCommand extends i.m{constructor(e){super(),this.payload=e,this.id="MOVE_MESH_TRIM_ALL_FLOORS"}}},33512:(e,t,s)=>{"use strict";s.d(t,{Z:()=>MeshTrimData});var i=s(32770),r=s(75256),n=s(64781),a=s(60697),o=s(56247),l=s(88512),d=s(28719),h=s(44283);const c=new l.Z("MeshTrimData");class MeshTrimData extends i.V{constructor(e,t){super(),this.maxTrimsPerFloor=o.t,this.maxAllFloorsTrims=o.t,this.numberOfTrims=0,this.meshTrimsByMeshGroup=new n.v,this.meshTrimsById=new n.v,this.onMeshGroupChangedCallbacks=new Set,this.onMeshTrimChangedCallbacks=new Set,this.updateMeshTrim=e=>{for(const t of this.onMeshTrimChangedCallbacks)t(e)},this.notifyMeshGroupChanges=e=>{for(const t of this.onMeshGroupChangedCallbacks)t(e)};for(const e of t){const t=e.meshGroup,s=new r.d;this.meshTrimsByMeshGroup.set(`${t}`,s)}1===t.length&&(this.singleFloorMeshGroup=t[0].meshGroup),this.meshTrimsByMeshGroup.set(`${a.e}`,new r.d);try{this.add(...Object.values(e))}catch(e){}}add(...e){const t=new Set;let s=!1;if(this.meshTrimsById.atomic((()=>{this.meshTrimsByMeshGroup.atomic((()=>{for(const i of e){void 0!==this.singleFloorMeshGroup&&(i.meshGroup=this.singleFloorMeshGroup);const e=i.meshGroup===a.e,n=`${i.meshGroup}`;this.meshTrimsByMeshGroup.has(n)||this.meshTrimsByMeshGroup.set(n,new r.d);const o=this.meshTrimsByMeshGroup.get(n);o.length<(e?this.maxAllFloorsTrims:this.maxTrimsPerFloor)?(o.push(i),this.meshTrimsById.set(i.id,i),t.add(i.meshGroup),i.onChanged(this.updateMeshTrim)):(c.debugWarn("Trims exceed floor limit (trimId, meshGroup):",i.id,i.meshGroup),s=!0)}}))})),t.forEach((e=>{const t=this.meshTrimsByMeshGroup.get(`${e}`);this.sortList(t),this.reassignIndexes(t),this.notifyMeshGroupChanges(e)})),this.updateDerivedProperties(),this.commit(),s)throw new d.M("Exceeding max trims")}delete(...e){const t=new Set;this.meshTrimsByMeshGroup.atomic((()=>{for(const s of e){const e=this.meshTrimsByMeshGroup.get(`${s.meshGroup}`),i=e.indexOf(s);if(i>=0){e.splice(i,1)[0].enabled=!1,t.add(s.meshGroup),s.removeOnChanged(this.updateMeshTrim)}else c.error("Could not delete mesh trim:"+s.id)}})),t.forEach((e=>{const t=this.meshTrimsByMeshGroup.get(`${e}`);this.reassignIndexes(t),this.notifyMeshGroupChanges(e)})),this.meshTrimsById.atomic((()=>{e.forEach((e=>{this.meshTrimsById.delete(e.id)}))})),this.updateDerivedProperties(),this.commit()}updateDerivedProperties(){this.numberOfTrims=this.meshTrimsById.length,this.maxTrimsPerFloor=o.t-this.meshTrimsByMeshGroup.get(`${a.e}`).length,this.maxAllFloorsTrims=o.t-this.getLongestTrimListLength()}onMeshGroupChanged(e){return(0,h.k1)((()=>this.onMeshGroupChangedCallbacks.add(e)),(()=>this.onMeshGroupChangedCallbacks.delete(e)))}onMeshTrimChanged(e){return(0,h.k1)((()=>this.onMeshTrimChangedCallbacks.add(e)),(()=>this.onMeshTrimChangedCallbacks.delete(e)))}getTrimById(e){return this.meshTrimsById.get(e)}getTrim(e,t){return this.meshTrimsByMeshGroup.has(`${e}`)?this.meshTrimsByMeshGroup.get(`${e}`).get(t):null}getTrimsForMeshGroup(e){return this.meshTrimsByMeshGroup.has(`${e}`)?this.meshTrimsByMeshGroup.get(`${e}`).values():[]}reassignIndexes(e){e.forEach(((e,t)=>{e.index=t}))}sortList(e){e.sort(((e,t)=>e.index-t.index))}getLongestTrimListLength(){let e=0;return this.meshTrimsByMeshGroup.keys.forEach((t=>{if(t===`${a.e}`)return;const s=this.meshTrimsByMeshGroup.get(t);e=Math.max(s.length,e)})),e}}},28719:(e,t,s)=>{"use strict";s.d(t,{M:()=>TooManyTrimsError});var i=s(31102);class TooManyTrimsError extends i.y{constructor(e){super(e),this.name="TooManyTrimsError"}}},11210:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>MeshTrimDataModule});var i=s(47724),r=s(39729),n=s(57361),a=s(71194),o=s(27326),l=s(12040),d=s(33394),h=s(62330),c=s(13789),u=s(33512);class CollectionSerializer{constructor(e){this.config=e}serialize(e){const{serializer:t}=this.config;if(!e||!t)return null;const s={};for(const i in e){const r=t.serialize(e[i]);r&&(s[i]=r)}return s}deserialize(e){const{deserializer:t}=this.config;if(!e||!t)return{};const s={};for(const i in e){const r=t.deserialize(e[i]);r&&(s[i]=r)}return s}}var m=s(38330),g=s(19674),p=s(31879),v=s(53694);const f=new(s(88512).Z)("JsonStoreMeshTrimDeserializer"),b=[{path:["position","x"],type:"number"},{path:["position","y"],type:"number"},{path:["position","z"],type:"number"},{path:["scale","x"],type:"number"},{path:["scale","y"],type:"number"},{path:["scale","z"],type:"number"},{path:["rotation","x"],type:"number"},{path:["rotation","y"],type:"number"},{path:["rotation","z"],type:"number"},{path:["rotation","w"],type:"number"},{path:["index"],type:"number"},{path:["enabled"],type:"boolean"},{path:["meshGroup"],type:"number"},{path:["id"],type:"string"},{path:["created"],type:"string"},{path:["modified"],type:"string"}];class JsonStoreMeshTrimDeserializer{constructor(){this.deserialize=e=>{if(!this.isValid(e))return f.debug("Unable to deserialize invalid mesh trim data",e),null;const{position:t,scale:s,rotation:i,index:r,enabled:n,meshGroup:a,created:o,modified:l,id:d,name:h,discardContents:c,activeInPanoMode:u}=e;return new v.r(g.ep.fromVisionVector(t),g.ep.fromVisionVector(s),g.ep.fromVisionQuaternion(i),r,n,a,(0,p.p)(o),(0,p.p)(l),d,h,c,u)}}isValid(e){if(!e||"object"!=typeof e)return!1;const t=e;return void 0===t.meshGroup&&(t.meshGroup=t.floorIndex),b.every((t=>this.hasRequiredField(e,t)))}hasRequiredField(e,t){try{return typeof t.path.reduce(((s,i)=>{if("object"==typeof s&&null!==s)return s[i];throw new Error(`data ${JSON.stringify(e)} must be addressable by ${t.path.join(".")} with a value of type ${t.type}`)}),e)===t.type}catch(e){return f.debug(e),!1}}}var S=s(87324);class JsonStoreMeshTrimSerializer{serialize(e){if(!e)return null;const{position:t,scale:s,rotation:i,index:r,enabled:n,meshGroup:a,created:o,modified:l,id:d,name:h,discardContents:c,activeInPanoMode:u}=e;return{position:(0,S.m)(g.ep.toVisionVector(t)),scale:(0,S.m)(g.ep.toVisionVector(s)),rotation:(0,S.J5)(g.ep.toVisionQuaternion(i)),index:r,enabled:n,meshGroup:a,created:(0,p.U)(o),modified:(0,p.U)(l),id:d,name:h,discardContents:c,activeInPanoMode:u}}}class JsonMeshTrimStore extends m.MU{constructor(e,t,s){const i=new JsonStoreMeshTrimDeserializer,r=new JsonStoreMeshTrimSerializer,n=new CollectionSerializer({deserializer:i,serializer:r});super({queue:e,path:`${t}/api/v1/jsonstore/model/trims/${s}`,batchUpdate:!0,deserialize:e=>n.deserialize(e),serialize:e=>n.serialize(e)})}}var C=s(65989),T=s(28719),w=s(60697);const{TRIM:B}=c.Z.WORKSHOP;class MeshTrimDataModule extends i.Y{constructor(){super(...arguments),this.name="trim_data",this.createMeshTrim=async e=>{try{this.data.add(e)}catch(e){if(e instanceof T.M){const e=B.MAX_TRIMS_ERROR_MESSAGE;this.engine.commandBinder.issueCommand(new d.I(e,{throttle:0,type:l.N.ERROR}))}}},this.deleteMeshTrim=async e=>{this.data.delete(e)},this.save=async()=>{const e=this.monitor.getDiffRecord();if(this.monitor.clearDiffRecord(),!e.length)return;const t={};for(const s of e)switch(s.action){case a.KI.added:case a.KI.updated:t[s.index]=this.data.getTrimById(s.index);break;case a.KI.removed:t[s.index]=null}try{await this.store.update(t)}catch(e){this.log.debug("error when writing to json storage"),this.log.debug(e);const t=B.UNABLE_TO_SAVE_CHANGES_ERROR_MESSAGE;this.engine.commandBinder.issueCommand(new d.I(t,{throttle:30,type:l.N.ERROR}))}},this.moveMeshTrimToAllFloors=async e=>{const t=e.enabled;this.deleteMeshTrim(e),e.meshGroup=w.e,e.enabled=t,this.createMeshTrim(e)},this.onMeshTrimsChanged=(0,h.P)(this.save,1e3)}async init(e,t){this.engine=t;const s=(await t.market.waitForData(o.c)).floors.getOrderedValues();this.store=new JsonMeshTrimStore(e.queue,e.baseUrl,e.modelId);let i={};try{i=await this.store.read()||{}}catch(e){this.log.debug("error when reading from json storage"),this.log.debug(e)}this.data=new u.Z(i,s),this.monitor=new n.c(this.data.meshTrimsById,{aggregationType:r.E.Immediate}),t.market.register(this,u.Z,this.data),this.bindings.push(t.commandBinder.addBinding(C.A,this.createMeshTrim),t.commandBinder.addBinding(C.yg,this.deleteMeshTrim),t.commandBinder.addBinding(C.dg,this.moveMeshTrimToAllFloors)),this.monitor.onChanged(this.onMeshTrimsChanged)}}},51858:(e,t,s)=>{"use strict";s.d(t,{M:()=>SetPanoOverlayCommand});var i=s(17386);class SetPanoOverlayCommand extends i.m{constructor(e,t,s){super(),this.id="SET_PANO_OVERLAY",this.payload={sweepId:e,texture:t,quaternion:s}}}},41029:(e,t,s)=>{"use strict";s.d(t,{K:()=>HttpFileStore});class HttpFileStore{constructor(e){this.config=e}async read(){const{url:e,deserializer:t,format:s,queue:i}=this.config;let r=await i.get(e);return"json"===s&&(r=JSON.parse(r)),t?t(r):r}}},56943:(e,t,s)=>{"use strict";function i(e,t){return Object.values(e).includes(t)}s.d(t,{p:()=>i})},1833:e=>{e.exports="uniform vec3 opacity;uniform vec3 radius;uniform vec3 feather;uniform vec3 color;varying vec4 vCenter;varying vec4 vPosition;void main(){float fragRadius=length(vPosition.xyz-vCenter.xyz);vec3 featherStart=radius-feather;vec3 circleAlphaWithFeather=1.-max(fragRadius-featherStart,0.)/(feather*2.);gl_FragColor=vec4(color.rgb*opacity*circleAlphaWithFeather,1.);}"},31530:e=>{e.exports="attribute mat4 instanceMatrix;varying vec4 vCenter;varying vec4 vPosition;void main(){vPosition=instanceMatrix*vec4(position,1.);vCenter=instanceMatrix*vec4(0.,0.,0.,1.);gl_Position=projectionMatrix*modelViewMatrix*vPosition;}"},24294:e=>{e.exports="varying vec4 maskPosition;varying vec4 panoPosition;uniform samplerCube maskTexture;uniform samplerCube panoBlurredMap0;uniform samplerCube panoBlurredMap1;uniform samplerCube panoBlurredMap2;uniform samplerCube panoBlurredMap3;const vec4 SELECTED_OUTLINE_COLOR=vec4(1.,1.,1.,1.);const vec4 HOVER_COLOR=vec4(1.,1.,1.,1.);vec4 combineBlurs(vec4 mask,vec4 blurredColor0,vec4 blurredColor1,vec4 blurredColor2,vec4 blurredColor3){float maskAlpha=mask.r;float selectedAlpha=mask.g;float hoveredAlpha=mask.b;float targetSigma=maskAlpha*(4.*4.-1.);float blurRatio=log2(1.+targetSigma);float panoAlpha=max(1.-abs(blurRatio-0.)/1.,0.);float blurAlpha0=max(1.-abs(blurRatio-1.)/1.,0.);float blurAlpha1=max(1.-abs(blurRatio-2.)/1.,0.);float blurAlpha2=max(1.-abs(blurRatio-3.)/1.,0.);float blurAlpha3=max(1.-abs(blurRatio-4.)/1.,0.);float alpha=blurAlpha0+blurAlpha1+blurAlpha2+blurAlpha3;vec4 color=(panoAlpha*blurredColor0+blurAlpha0*blurredColor0+blurAlpha1*blurredColor1+blurAlpha2*blurredColor2+blurAlpha3*blurredColor3);color.a=alpha;float selectedMaskAlpha=smoothstep(0.65,0.75,selectedAlpha)*(1.-smoothstep(0.85,0.95,selectedAlpha));color=mix(color,SELECTED_OUTLINE_COLOR,selectedMaskAlpha);color=mix(color,HOVER_COLOR,hoveredAlpha*0.3);return color;}void main(){vec4 mask=textureCube(maskTexture,maskPosition.xyz);\n#ifdef DEBUG_BLUR_LEVELS\nmask=vec4(fract(gl_FragCoord.x/2048.),0.,0.,1.);\n#endif\nvec4 blurredColor0=textureCube(panoBlurredMap0,panoPosition.xyz);vec4 blurredColor1=textureCube(panoBlurredMap1,panoPosition.xyz);vec4 blurredColor2=textureCube(panoBlurredMap2,panoPosition.xyz);vec4 blurredColor3=textureCube(panoBlurredMap3,panoPosition.xyz);\n# ifdef DEBUG_BLUR_LEVELS\nif(gl_FragCoord.y>2000.){blurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);}\n#elif defined(DEBUG_BLUR_COLORS)\nblurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);\n#endif\ngl_FragColor=combineBlurs(mask,blurredColor0,blurredColor1,blurredColor2,blurredColor3);}"},22627:e=>{e.exports="varying vec4 maskPosition;varying vec4 panoPosition;uniform mat4 maskMatrix;uniform mat4 panoMatrix1;uniform mat4 panoMatrix2;void main(){vec4 worldPosition=modelMatrix*vec4(position,1.);maskPosition=maskMatrix*worldPosition;panoPosition=panoMatrix2*panoMatrix1*worldPosition;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},33359:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionAssets"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",alias:{kind:"Name",value:"objectBlur"},name:{kind:"Name",value:"asset"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"StringValue",value:"blurs/suggestions",block:!1}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"status"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"BlurSuggestionAsset"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"version"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:383}};t.loc.source={body:'# Fetches public output files from the Vision Catalog,\n# only available after platform 21.21.1 release\nquery GetVisionAssets($modelId: ID!) {\n  model(id: $modelId) {\n    objectBlur: asset(id: "blurs/suggestions") {\n      id\n      status\n      contentType\n      filename\n      format\n      url\n      validUntil\n      ... on BlurSuggestionAsset {\n          version\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function r(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionAssets=function(e,t){var s={kind:e.kind,definitions:[r(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var n=i[t]||new Set,a=new Set,o=new Set;for(n.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){a.has(e)||(a.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return a.forEach((function(t){var i=r(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionAssets")},55594:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionCatalog"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"catalog"},arguments:[{kind:"Argument",name:{kind:"Name",value:"formats"},value:{kind:"ListValue",values:[{kind:"StringValue",value:"json",block:!1}]}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"description"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:271}};t.loc.source={body:'# Fetches Vision Catalog assets, restricted to staff users\nquery GetVisionCatalog($modelId: ID!) {\n  model(id: $modelId) {\n    assets {\n      catalog(formats: ["json"]) {\n        format\n        type\n        contentType\n        description\n        url\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function r(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionCatalog=function(e,t){var s={kind:e.kind,definitions:[r(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var n=i[t]||new Set,a=new Set,o=new Set;for(n.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){a.has(e)||(a.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return a.forEach((function(t){var i=r(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionCatalog")}}]);